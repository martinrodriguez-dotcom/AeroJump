<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroJump Gualeguaych√∫ - Gesti√≥n v2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --color-violet: #7c3aed;
            --color-orange: #f97316;
            --color-slate: #1e293b;
        }

        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: var(--color-slate); }

        /* Sistema de Modales */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        .modal.is-open { display: flex; }

        .modal-content {
            background: white;
            width: 100%;
            max-height: 92vh;
            border-radius: 2.5rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3);
        }

        .modal-header { padding: 1.5rem 2rem; border-bottom: 1px solid #f1f5f9; flex-shrink: 0; }
        .modal-body { padding: 1.5rem 2rem; overflow-y: auto; flex-grow: 1; }
        .modal-footer { padding: 1.5rem 2rem; border-top: 1px solid #f1f5f9; flex-shrink: 0; background: #ffffff; }

        /* Estilos de Lista de Ventas */
        .sale-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 1rem;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.2s;
        }
        .sale-row:hover { background-color: #f5f3ff; }

        /* Botones de Horario */
        .time-slot {
            padding: 0.75rem;
            border-radius: 1rem;
            border: 2px solid #e2e8f0;
            text-align: center;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
        }
        .time-slot.selected { background: var(--color-violet); border-color: var(--color-violet); color: white; }
        .time-slot.disabled { opacity: 0.3; cursor: not-allowed; background: #f1f5f9; }
        .time-slot .capacity-info { font-size: 0.6rem; font-weight: 800; }

        /* Calendario */
        .day-cell { border-radius: 1.25rem; transition: all 0.2s; border: 2px solid #fff; background: white; min-height: 100px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .day-cell:hover { border-color: var(--color-violet); transform: scale(1.03); z-index: 10; }
        .booking-count { background: var(--color-violet); color: white; border-radius: 99px; padding: 2px 8px; font-size: 0.65rem; font-weight: 900; }
        .booking-count.event { background: var(--color-orange); }

        /* Men√∫ */
        #main-menu {
            position: fixed; top: 0; left: 0; height: 100vh; width: 300px;
            background: white; transform: translateX(-100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 500; box-shadow: 20px 0 50px rgba(0,0,0,0.1);
        }
        #main-menu.is-open { transform: translateX(0); }

        .is-hidden { display: none !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        /* Animaci√≥n Carga */
        @keyframes jump { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-30px); } }
        .jumping-child { animation: jump 0.8s ease-in-out infinite; }
    </style>
</head>
<body>

    <!-- ============================================= -->
    <!-- 1. CAPA DE AUTENTICACI√ìN                     -->
    <!-- ============================================= -->
    <div id="login-view" class="view-container flex items-center justify-center min-h-screen p-4">
        <div class="bg-white p-10 rounded-[3.5rem] shadow-2xl w-full max-w-sm text-center">
            <div class="inline-block p-5 bg-violet-100 rounded-3xl mb-6"><span class="text-4xl">üöÄ</span></div>
            <h2 class="text-3xl font-black text-slate-800 tracking-tighter uppercase italic mb-2">AeroJump</h2>
            <p class="text-slate-400 font-bold text-[10px] uppercase tracking-widest mb-10">Acceso Administrativo</p>
            <form id="login-form" class="space-y-4">
                <input type="email" id="login-email" placeholder="Email" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-violet-500 text-sm" required>
                <input type="password" id="login-password" placeholder="Contrase√±a" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-violet-500 text-sm" required>
                <button type="submit" class="bg-violet-600 text-white w-full py-4 rounded-2xl font-black uppercase tracking-widest shadow-xl active:scale-95 transition-all">Entrar al Sistema</button>
            </form>
            <a href="#" id="show-register" class="block mt-8 text-[10px] text-violet-600 font-black uppercase italic hover:underline">Solicitar cuenta nueva</a>
        </div>
    </div>

    <div id="register-view" class="view-container flex items-center justify-center min-h-screen p-4 is-hidden">
        <div class="bg-white p-10 rounded-[3.5rem] shadow-2xl w-full max-w-sm text-center border">
            <h2 class="text-3xl font-black text-slate-800 tracking-tighter uppercase italic mb-8">Nueva Cuenta</h2>
            <form id="register-form" class="space-y-4 text-left">
                <input type="email" id="register-email" placeholder="Email" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border" required>
                <input type="password" id="register-password" placeholder="M√≠nimo 6 caracteres" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border" required>
                <button type="submit" class="bg-violet-600 text-white w-full py-4 rounded-2xl font-black uppercase tracking-widest shadow-xl">Registrar Admin</button>
            </form>
            <a href="#" id="show-login" class="block mt-8 text-[11px] text-violet-600 font-black uppercase italic">Volver al Login</a>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- 2. CONTENEDOR PRINCIPAL                      -->
    <!-- ============================================= -->
    <div id="app-container" class="is-hidden">
        
        <header class="fixed top-0 left-0 right-0 bg-white/90 backdrop-blur-md shadow-sm p-4 flex justify-between items-center z-50 border-b">
            <div class="flex items-center gap-3">
                <button id="menu-btn" class="p-3 rounded-2xl bg-slate-50 hover:bg-slate-100 transition-all active:scale-90">
                    <svg class="h-6 w-6 text-slate-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <div class="leading-none">
                    <h1 class="text-xl font-black text-slate-800 uppercase italic">AeroJump</h1>
                    <span class="text-[8px] font-black text-violet-500 uppercase tracking-widest">Gualeguaych√∫</span>
                </div>
            </div>
            <button id="header-sale-btn" class="bg-orange-500 text-white px-6 py-3 rounded-2xl font-black shadow-lg uppercase text-[10px] active:scale-90 transition-all">Nueva Venta</button>
        </header>

        <nav id="main-menu" class="p-8 flex flex-col">
            <div class="border-b border-slate-100 pb-6 mb-8 text-left">
                <p id="user-email-display" class="font-black text-violet-700 truncate text-xs italic"></p>
                <button id="logout-btn" class="mt-4 text-[10px] font-black text-slate-400 uppercase hover:text-red-500 transition-colors">Cerrar Sesi√≥n</button>
            </div>
            <div class="space-y-3">
                <a href="#" class="menu-item flex items-center gap-4 p-4 rounded-2xl font-black text-slate-600 hover:bg-violet-50 hover:text-violet-700 transition-all text-xs uppercase italic" data-view="calendar">üóìÔ∏è Agenda Saltos</a>
                <a href="#" class="menu-item flex items-center gap-4 p-4 rounded-2xl font-black text-slate-600 hover:bg-violet-50 hover:text-violet-700 transition-all text-xs uppercase italic" data-view="productos">ü•§ Stock Kiosco</a>
                <a href="#" class="menu-item flex items-center gap-4 p-4 rounded-2xl font-black text-slate-600 hover:bg-violet-50 hover:text-violet-700 transition-all text-xs uppercase italic" data-view="caja">üí∞ Arqueo Caja</a>
                <a href="#" class="menu-item flex items-center gap-4 p-4 rounded-2xl font-black text-slate-600 hover:bg-violet-50 hover:text-violet-700 transition-all text-xs uppercase italic" data-view="stats">üìä Estad√≠sticas</a>
                <a href="#" class="menu-item flex items-center gap-4 p-4 rounded-2xl font-black text-slate-600 hover:bg-violet-50 hover:text-violet-700 transition-all text-xs uppercase italic" data-view="configuracion">‚öôÔ∏è Tarifas</a>
            </div>
        </nav>
        <div id="menu-overlay" class="fixed inset-0 bg-slate-900/40 z-40 hidden"></div>

        <main class="pt-24 pb-12 px-4 max-w-6xl mx-auto">
            
            <!-- VISTA: CALENDARIO -->
            <div id="calendar-view" class="view-container">
                <div class="flex justify-between items-center bg-white p-6 rounded-[2.5rem] shadow-xl mb-8 border">
                    <button id="prev-month-btn" class="p-3 text-slate-300 font-black hover:text-violet-600 transition-colors">‚óÄ</button>
                    <h2 id="current-month-year" class="text-2xl font-black text-violet-700 uppercase italic tracking-tighter"></h2>
                    <button id="next-month-btn" class="p-3 text-slate-300 font-black hover:text-violet-600 transition-colors">‚ñ∂</button>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-4"></div>
            </div>

            <!-- VISTA: PRODUCTOS -->
            <div id="productos-view" class="view-container is-hidden">
                <div class="flex justify-between items-center mb-10 text-left">
                    <div>
                        <h2 class="text-4xl font-black italic uppercase text-slate-800 leading-none">Inventario</h2>
                        <p class="text-slate-400 font-bold text-[10px] uppercase mt-2">Control de mercader√≠a</p>
                    </div>
                    <button id="add-product-btn" class="bg-violet-600 text-white px-8 py-4 rounded-2xl font-black shadow-xl text-[10px] active:scale-95 transition-all">+ NUEVO</button>
                </div>
                
                <div id="product-form-container" class="bg-white p-10 rounded-[3rem] shadow-2xl mb-10 is-hidden border-4 border-violet-50 text-left">
                    <form id="product-form" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="md:col-span-2">
                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Nombre Comercial</label>
                            <input type="text" id="prod-name" class="w-full p-5 bg-slate-50 rounded-2xl font-bold border focus:ring-4 focus:ring-violet-50 outline-none" required>
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Stock Inicial</label>
                            <input type="number" id="prod-stock" class="w-full p-5 bg-slate-50 rounded-2xl font-bold border" required min="0">
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Costo Bulto ($)</label>
                            <input type="number" id="prod-batch-cost" class="w-full p-5 bg-violet-50 rounded-2xl font-black text-xl text-violet-700 border" required>
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Unidades x Bulto</label>
                            <input type="number" id="prod-batch-qty" class="w-full p-5 bg-slate-50 rounded-2xl font-bold border" required min="1" value="1">
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Margen (%)</label>
                            <input type="number" id="prod-profit-pct" class="w-full p-5 bg-orange-50 rounded-2xl font-bold border" value="40">
                        </div>
                        <div class="md:col-span-3 p-8 bg-slate-900 rounded-[2.5rem] flex flex-col md:flex-row justify-between items-center gap-8 shadow-2xl">
                            <div class="text-left">
                                <span class="text-[10px] font-black text-green-400 uppercase block mb-1 italic">Precio Sugerido Venta</span>
                                <span id="prod-suggested-price" class="text-5xl font-black text-white italic tracking-tighter">$0</span>
                            </div>
                            <div class="flex gap-4 w-full md:w-auto">
                                <button type="button" id="cancel-product-btn" class="flex-1 px-8 py-5 text-slate-400 font-black uppercase text-xs">Descartar</button>
                                <button type="submit" class="flex-2 bg-green-600 text-white px-12 py-5 rounded-2xl font-black uppercase text-xs shadow-xl active:scale-95 transition-all">Guardar Ficha</button>
                            </div>
                        </div>
                        <input type="hidden" id="prod-unit-cost">
                    </form>
                </div>
                <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <!-- VISTA: CAJA -->
            <div id="caja-view" class="view-container is-hidden">
                <h2 class="text-4xl font-black mb-10 text-center uppercase italic text-slate-800">Arqueo de Caja</h2>
                <div class="bg-slate-900 p-12 rounded-[4rem] text-white mb-10 shadow-2xl text-center relative overflow-hidden">
                    <p class="text-[10px] font-black text-violet-400 uppercase mb-2 tracking-[0.3em] italic">Recaudaci√≥n General AeroJump</p>
                    <p id="caja-total-combined" class="text-7xl font-black italic tracking-tighter">$0</p>
                </div>
                <div id="caja-daily-list" class="space-y-4 text-left"></div>
            </div>

            <!-- VISTA: CONFIGURACI√ìN -->
            <div id="configuracion-view" class="view-container is-hidden max-w-md mx-auto">
                <div class="bg-white p-10 rounded-[3.5rem] shadow-2xl border text-left">
                    <h2 class="text-2xl font-black mb-10 uppercase italic text-center text-slate-800">Maestro de Tarifas</h2>
                    <form id="config-form" class="space-y-8">
                        <div>
                            <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-2 italic tracking-widest">Costo Salto 1 Hora</label>
                            <input type="number" id="config-court1-price" class="w-full p-5 bg-slate-50 rounded-2xl font-black text-2xl text-violet-700 outline-none border focus:ring-4 focus:ring-violet-50">
                        </div>
                        <button type="submit" class="w-full bg-slate-900 text-white py-6 rounded-[2rem] font-black uppercase italic border-b-8 border-black active:scale-95 transition-all">Actualizar Tarifas</button>
                    </form>
                </div>
            </div>

            <!-- VISTA: ESTAD√çSTICAS -->
            <div id="stats-view" class="view-container is-hidden text-left">
                <h2 class="text-4xl font-black mb-10 uppercase italic text-slate-800">Rankings</h2>
                <div id="stats-list" class="space-y-4"></div>
            </div>
        </main>
    </div>

    <!-- ============================================= -->
    <!-- SISTEMA DE MODALES                           -->
    <!-- ============================================= -->

    <!-- MODAL RESERVA CON SCROLL -->
    <div id="booking-modal" class="modal">
        <div class="modal-content max-w-3xl">
            <div class="modal-header text-left">
                <h3 id="booking-modal-title" class="text-3xl font-black text-violet-900 uppercase italic tracking-tighter">Reservar Salto</h3>
            </div>
            <form id="booking-form" class="flex flex-col overflow-hidden text-left">
                <div class="modal-body custom-scrollbar">
                    <input type="hidden" id="booking-id"><input type="hidden" id="booking-date">
                    <div class="space-y-8">
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2 italic tracking-widest">Responsable</label>
                            <input type="text" id="teamName" class="w-full p-6 bg-slate-50 rounded-3xl font-black text-2xl italic outline-none focus:ring-4 focus:ring-violet-50 border" required autocomplete="off">
                            <div id="teamName-suggestions" class="absolute z-50 bg-white shadow-2xl rounded-2xl is-hidden w-full max-w-md border overflow-hidden"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="p-6 bg-slate-50 rounded-[2.5rem] border">
                                <label class="text-[10px] font-black uppercase text-slate-400 block mb-2">Cantidad de Saltadores</label>
                                <div class="flex items-center gap-6">
                                    <button type="button" onclick="window.adjustJumpers(-1)" class="w-14 h-14 bg-white rounded-2xl font-black shadow-md text-xl active:scale-90 transition-all">-</button>
                                    <input type="number" id="peopleCount" class="w-20 text-center font-black text-4xl bg-transparent outline-none italic" value="1" min="1" max="30">
                                    <button type="button" onclick="window.adjustJumpers(1)" class="w-14 h-14 bg-white rounded-2xl font-black shadow-md text-xl active:scale-90 transition-all">+</button>
                                </div>
                            </div>
                            <div class="p-6 bg-violet-50 rounded-[2.5rem] border border-violet-100 flex flex-col justify-center">
                                <span class="text-[10px] font-black text-violet-400 uppercase mb-1">Costo Base Unitario</span>
                                <input type="number" id="costPerHour" class="bg-transparent font-black text-4xl text-violet-700 outline-none italic">
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2 block mb-4 italic tracking-widest">Cupos Disponibles (L√≠mite: 30)</label>
                            <div id="court-hours-list" class="grid grid-cols-3 sm:grid-cols-5 gap-3"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer flex flex-col sm:flex-row justify-between items-center gap-6">
                    <div class="text-left leading-none">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2 italic">Total a Liquidar</span>
                        <p id="booking-total" class="text-6xl font-black text-violet-700 italic tracking-tighter leading-none">$0</p>
                    </div>
                    <div class="flex gap-4 w-full sm:w-auto">
                        <button type="button" onclick="window.closeModals()" class="flex-1 px-8 py-5 font-black text-slate-300 uppercase text-[10px] tracking-widest">Atr√°s</button>
                        <button type="submit" class="flex-2 bg-violet-600 text-white px-14 py-5 rounded-[2rem] font-black uppercase shadow-xl active:scale-95 transition-all text-sm border-b-8 border-violet-900 italic">Confirmar Turno</button>
                    </div>
                </div>
                <input type="checkbox" id="rentGrill" class="hidden"><input type="number" id="grillCost" class="hidden">
            </form>
        </div>
    </div>

    <!-- MODAL VENTAS (LISTA DETALLADA) -->
    <div id="sale-modal" class="modal">
        <div class="modal-content max-w-4xl">
            <div class="modal-header flex justify-between items-center text-left">
                <div>
                    <h3 class="text-3xl font-black text-orange-600 uppercase italic tracking-tighter leading-none">Venta de Kiosco</h3>
                    <p class="text-[9px] text-slate-400 font-bold uppercase mt-1">Caja Registradora AeroJump</p>
                </div>
                <button onclick="window.closeModals()" class="p-3 text-slate-300 hover:text-slate-600"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>

            <div class="bg-slate-50 border-b px-8 py-4">
                <input type="text" id="sale-catalog-filter" class="w-full p-5 bg-white rounded-2xl font-bold border-2 border-slate-200 outline-none focus:border-orange-500 shadow-inner italic" placeholder="üîç Buscar por nombre del producto...">
            </div>

            <div class="modal-body custom-scrollbar bg-white p-0">
                <div class="sticky top-0 bg-slate-900 text-violet-400 px-8 py-3 grid grid-cols-12 gap-4 text-[10px] font-black uppercase tracking-widest z-10">
                    <div class="col-span-5 text-left">Producto</div>
                    <div class="col-span-2 text-center">Costo</div>
                    <div class="col-span-2 text-center">Stock</div>
                    <div class="col-span-3 text-center">Cantidad</div>
                </div>
                <div id="sale-catalog-list" class="divide-y">
                    <!-- Filas inyectadas por JS -->
                </div>
            </div>
            
            <div class="modal-footer bg-slate-900 text-white">
                <div class="flex justify-between items-center w-full">
                    <div class="text-left">
                        <span class="text-[10px] font-black text-violet-400 uppercase tracking-widest block mb-1 italic leading-none">Total Venta</span>
                        <span id="sale-total-display" class="text-7xl font-black italic tracking-tighter leading-none text-white">$0</span>
                    </div>
                    <button id="confirm-sale-btn" class="bg-orange-500 text-white px-16 py-6 rounded-[2.5rem] font-black uppercase shadow-2xl disabled:opacity-20 transition-all active:scale-95 italic text-sm" disabled>Cerrar Venta</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL OPCIONES D√çA -->
    <div id="options-modal" class="modal">
        <div class="modal-content max-w-sm p-10 text-center border-4 border-violet-50">
            <h3 class="text-3xl font-black mb-10 text-slate-800 uppercase italic tracking-tighter leading-none">Turnos del D√≠a</h3>
            <div id="daily-bookings-list" class="space-y-3 mb-10 text-left custom-scrollbar max-h-64 overflow-y-auto italic"></div>
            <button id="add-new-booking-btn" class="w-full bg-violet-600 text-white py-6 rounded-[2rem] font-black shadow-xl uppercase text-[10px] active:scale-95 border-b-8 border-violet-950 italic tracking-widest">+ AGREGAR TURNO</button>
            <button onclick="window.closeModals()" class="mt-6 text-slate-300 font-black uppercase text-[10px] tracking-widest hover:text-slate-600 transition-colors">Regresar</button>
        </div>
    </div>

    <!-- OVERLAY MENSAJES -->
    <div id="message-overlay" class="modal bg-white/95 backdrop-blur-md">
        <div class="flex flex-col items-center justify-center min-h-screen text-center p-10">
            <svg width="120" height="120" viewBox="0 0 100 100" class="mb-10">
                <path d="M10 80 Q 50 80 90 80" stroke="#7c3aed" stroke-width="8" fill="none" stroke-linecap="round" class="trampoline-line"/>
                <g class="jumping-child"><circle cx="50" cy="35" r="10" fill="#f97316"/><line x1="50" y1="45" x2="50" y2="70" stroke="#1e293b" stroke-width="5" stroke-linecap="round"/></g>
            </svg>
            <p id="message-text" class="text-2xl font-black text-slate-800 uppercase italic tracking-tighter"></p>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- L√ìGICA CORE                                  -->
    <!-- ============================================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, updateDoc, deleteDoc, collection, query, where, onSnapshot, getDocs, Timestamp, orderBy, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBz0V2ieSXehafKWRNQprb951NVN5FvBD4",
            authDomain: "aerojump-841fb.firebaseapp.com",
            projectId: "aerojump-841fb",
            storageBucket: "aerojump-841fb.firebasestorage.app",
            messagingSenderId: "68080726646",
            appId: "1:68080726646:web:a830613a1278871d416557"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "aerojump-gualeguaychu";

        const getPublicCollection = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);
        const getPublicDoc = (name, id) => doc(db, 'artifacts', appId, 'public', 'data', name, id);

        let user = null;
        let allMonthBookings = [];
        let allProducts = [];
        let cartItems = {}; // { productId: quantity }
        let appSettings = { court1Price: 5000 };
        const OPERATING_HOURS = [9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23];
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        let currentMonthDate = new Date();
        const MAX_CAPACITY = 30;

        // --- AUTH CONTROL ---
        onAuthStateChanged(auth, async (u) => {
            if (u) {
                user = u;
                document.getElementById('user-email-display').textContent = u.email;
                document.getElementById('login-view').classList.add('is-hidden');
                document.getElementById('app-container').classList.remove('is-hidden');
                await initApp();
            } else {
                document.getElementById('login-view').classList.remove('is-hidden');
                document.getElementById('app-container').classList.add('is-hidden');
            }
        });

        async function initApp() {
            await loadSettings();
            syncBookings();
            syncProducts();
        }

        // --- BOOKING LOGIC ---
        function getOccupancyForDay(dateStr) {
            const occupancy = {};
            OPERATING_HOURS.forEach(h => occupancy[h] = 0);
            allMonthBookings.filter(b => b.day === dateStr).forEach(b => {
                const count = parseInt(b.peopleCount) || 0;
                b.courtHours.forEach(h => { if (occupancy[h] !== undefined) occupancy[h] += count; });
            });
            return occupancy;
        }

        function renderTimeSlots(dateStr, editingId = null) {
            const occupancy = getOccupancyForDay(dateStr);
            const currentBooking = allMonthBookings.find(b => b.id === editingId);
            const selectedHours = currentBooking ? currentBooking.courtHours : [];
            if (currentBooking) {
                const myCount = parseInt(currentBooking.peopleCount) || 0;
                selectedHours.forEach(h => occupancy[h] -= myCount);
            }
            const list = document.getElementById('court-hours-list');
            list.innerHTML = '';
            OPERATING_HOURS.forEach(h => {
                const available = MAX_CAPACITY - occupancy[h];
                const isFull = available <= 0;
                const btn = document.createElement('button');
                btn.type = "button";
                btn.className = `time-slot ${isFull ? 'disabled' : ''} ${selectedHours.includes(h) ? 'selected' : ''}`;
                btn.innerHTML = `<span class="font-black text-sm">${h}:00</span><span class="capacity-info ${available < 5 ? 'text-red-500' : 'text-slate-400'}">${available} libres</span>`;
                if (!isFull) { btn.onclick = () => { btn.classList.toggle('selected'); updateBookingPrice(); }; }
                list.appendChild(btn);
            });
        }

        async function showBookingModal(dateStr, booking = null) {
            document.getElementById('booking-form').reset();
            document.getElementById('booking-date').value = dateStr;
            document.getElementById('booking-id').value = booking ? booking.id : '';
            document.getElementById('teamName').value = booking ? booking.teamName : '';
            document.getElementById('peopleCount').value = booking ? booking.peopleCount : 1;
            document.getElementById('costPerHour').value = appSettings.court1Price;
            renderTimeSlots(dateStr, booking?.id);
            updateBookingPrice();
            document.getElementById('booking-modal').classList.add('is-open');
        }

        function updateBookingPrice() {
            const h = document.getElementById('court-hours-list').querySelectorAll('.time-slot.selected').length;
            const p = parseFloat(document.getElementById('costPerHour').value) || 0;
            const jumpers = parseInt(document.getElementById('peopleCount').value) || 1;
            document.getElementById('booking-total').textContent = `$${(h * p * jumpers).toLocaleString()}`;
        }

        // --- KIOSCO LOGIC ---
        function renderSaleCatalog(filter = "") {
            const container = document.getElementById('sale-catalog-list');
            container.innerHTML = '';
            const filtered = allProducts.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()));
            
            filtered.forEach(p => {
                const selectedQty = cartItems[p.id] || 0;
                const row = document.createElement('div');
                row.className = 'sale-row px-8';
                row.innerHTML = `
                    <div class="col-span-5 text-left"><p class="font-black text-xs uppercase text-slate-700">${p.name}</p></div>
                    <div class="col-span-2 text-center"><p class="font-black text-sm text-violet-600">$${p.salePrice}</p></div>
                    <div class="col-span-2 text-center"><p class="font-bold text-[10px] text-slate-400">${p.stock} un.</p></div>
                    <div class="col-span-3">
                        <div class="flex items-center justify-center gap-2">
                            <button onclick="window.updateCatalogQty('${p.id}', -1)" class="w-8 h-8 bg-slate-100 rounded-lg font-black active:scale-90">-</button>
                            <span class="w-6 text-center font-black text-sm italic ${selectedQty > 0 ? 'text-violet-600' : 'text-slate-300'}">${selectedQty}</span>
                            <button onclick="window.updateCatalogQty('${p.id}', 1)" class="w-8 h-8 bg-slate-100 rounded-lg font-black active:scale-90" ${selectedQty >= p.stock ? 'disabled' : ''}>+</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
            updateSaleTotal();
        }

        window.updateCatalogQty = (id, delta) => {
            const p = allProducts.find(x => x.id === id);
            if(!p) return;
            let current = cartItems[id] || 0;
            current += delta;
            if (current <= 0) delete cartItems[id];
            else if (current > p.stock) current = p.stock;
            else cartItems[id] = current;
            renderSaleCatalog(document.getElementById('sale-catalog-filter').value);
        };

        function updateSaleTotal() {
            let total = 0;
            Object.keys(cartItems).forEach(id => {
                const p = allProducts.find(x => x.id === id);
                if(p) total += (p.salePrice * cartItems[id]);
            });
            document.getElementById('sale-total-display').textContent = `$${total.toLocaleString()}`;
            document.getElementById('confirm-sale-btn').disabled = total <= 0;
        }

        // --- EVENT HANDLERS ---
        document.getElementById('header-sale-btn').onclick = () => {
            cartItems = {};
            document.getElementById('sale-catalog-filter').value = '';
            renderSaleCatalog();
            document.getElementById('sale-modal').classList.add('is-open');
        };

        document.getElementById('menu-btn').onclick = () => {
            document.getElementById('main-menu').classList.toggle('is-open');
            document.getElementById('menu-overlay').classList.toggle('hidden');
        };

        document.getElementById('menu-overlay').onclick = () => {
            document.getElementById('main-menu').classList.remove('is-open');
            document.getElementById('menu-overlay').classList.add('hidden');
        };

        document.getElementById('confirm-sale-btn').onclick = async () => {
            const btn = document.getElementById('confirm-sale-btn');
            btn.disabled = true;
            try {
                const batch = writeBatch(db);
                const hoy = new Date().toISOString().split('T')[0];
                for (const id of Object.keys(cartItems)) {
                    const p = allProducts.find(x => x.id === id);
                    const qty = cartItems[id];
                    batch.set(doc(collection(db, "sales")), {
                        name: p.name, qty, total: p.salePrice * qty,
                        day: hoy, monthYear: hoy.substring(0, 7), timestamp: Timestamp.now(), adminEmail: user.email
                    });
                    batch.update(getPublicDoc("products", id), { stock: p.stock - qty });
                }
                await batch.commit();
                alert("Venta completada");
                window.closeModals();
            } catch (err) { alert(err.message); } finally { btn.disabled = false; }
        };

        // --- SYNC & RENDER ---
        function syncBookings() {
            const monthYear = `${currentMonthDate.getFullYear()}-${String(currentMonthDate.getMonth() + 1).padStart(2, '0')}`;
            onSnapshot(query(getPublicCollection("bookings"), where("monthYear", "==", monthYear)), (snap) => {
                allMonthBookings = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderCalendar();
            });
        }

        function renderCalendar() {
            calendarGrid.innerHTML = '';
            currentMonthYearEl.textContent = `${monthNames[currentMonthDate.getMonth()]} ${currentMonthDate.getFullYear()}`;
            const firstDay = new Date(currentMonthDate.getFullYear(), currentMonthDate.getMonth(), 1).getDay();
            const lastDate = new Date(currentMonthDate.getFullYear(), currentMonthDate.getMonth() + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) { calendarGrid.appendChild(document.createElement('div')); }
            for (let i = 1; i <= lastDate; i++) {
                const ds = `${currentMonthDate.getFullYear()}-${String(currentMonthDate.getMonth() + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const bks = allMonthBookings.filter(b => b.day === ds);
                const cell = document.createElement('div');
                cell.className = 'day-cell p-3 flex flex-col justify-between text-left';
                cell.innerHTML = `<span class="font-black italic text-slate-800 text-lg">${i}</span>`;
                if (bks.length > 0) {
                    const badge = document.createElement('div');
                    badge.className = `booking-count ${bks.some(b => b.type === 'event') ? 'event' : ''}`;
                    badge.textContent = bks.length;
                    cell.appendChild(badge);
                }
                cell.onclick = () => { if(bks.length > 0) showOptionsModal(ds, bks); else showBookingModal(ds); };
                calendarGrid.appendChild(cell);
            }
        }

        function showOptionsModal(ds, bks) {
            const list = document.getElementById('daily-bookings-list');
            list.innerHTML = '';
            bks.forEach(b => {
                list.innerHTML += `<div class="p-4 bg-slate-50 rounded-2xl mb-2 flex justify-between items-center border">
                    <div><p class="font-black text-xs uppercase">${b.teamName}</p><p class="text-[9px] font-bold text-slate-400">${b.courtHours.join(', ')}hs</p></div>
                    <button onclick="window.deleteBooking('${b.id}')" class="text-red-500 font-black text-xs uppercase">X</button>
                </div>`;
            });
            document.getElementById('add-new-booking-btn').onclick = () => { window.closeModals(); showBookingModal(ds); };
            document.getElementById('options-modal').classList.add('is-open');
        }

        function syncProducts() {
            onSnapshot(getPublicCollection("products"), (snap) => {
                allProducts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderInventory();
            });
        }

        function renderInventory() {
            const list = document.getElementById('product-list');
            list.innerHTML = '';
            allProducts.forEach(p => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-3xl shadow-sm border flex flex-col gap-4 text-left';
                card.innerHTML = `
                    <div class="flex justify-between items-start leading-none">
                        <div><h4 class="font-black italic uppercase text-slate-800 text-lg mb-1">${p.name}</h4><span class="text-[9px] font-black uppercase text-violet-500">Stock: ${p.stock} un.</span></div>
                        <strong class="text-2xl font-black text-violet-600 italic">$${p.salePrice}</strong>
                    </div>
                    <div class="grid grid-cols-2 gap-2"><button onclick="window.deleteProduct('${p.id}')" class="bg-orange-50 text-orange-500 p-2 rounded-xl text-[8px] font-black uppercase">üóëÔ∏è Borrar</button></div>
                `;
                list.appendChild(card);
            });
        }

        // --- UTILS ---
        async function loadSettings() {
            const d = await getDoc(getPublicDoc("app_settings", "prices"));
            if (d.exists()) { appSettings = d.data(); document.getElementById('config-court1-price').value = appSettings.court1Price; }
        }

        window.closeModals = () => { document.querySelectorAll('.modal').forEach(m => m.classList.remove('is-open')); };
        window.adjustJumpers = (val) => {
            const input = document.getElementById('peopleCount');
            let n = parseInt(input.value) + val;
            if (n < 1) n = 1; if (n > 30) n = 30;
            input.value = n;
            renderTimeSlots(document.getElementById('booking-date').value, document.getElementById('booking-id').value);
            updateBookingPrice();
        };

        window.deleteBooking = async (id) => { if(confirm("¬øEliminar turno?")) { await deleteDoc(getPublicDoc("bookings", id)); window.closeModals(); } };
        window.deleteProduct = async (id) => { if(confirm("¬øBorrar producto?")) await deleteDoc(getPublicDoc("products", id)); };
        
        window.prevMonth = () => { currentMonthDate.setMonth(currentMonthDate.getMonth() - 1); syncBookings(); };
        window.nextMonth = () => { currentMonthDate.setMonth(currentMonthDate.getMonth() + 1); syncBookings(); };

        document.getElementById('booking-form').onsubmit = async (e) => {
            e.preventDefault();
            const selected = Array.from(document.getElementById('court-hours-list').querySelectorAll('.time-slot.selected')).map(el => parseInt(el.querySelector('span').textContent));
            if (selected.length === 0) return alert("Selecciona horario");
            const data = {
                teamName: document.getElementById('teamName').value,
                day: document.getElementById('booking-date').value,
                monthYear: document.getElementById('booking-date').value.substring(0, 7),
                peopleCount: parseInt(document.getElementById('peopleCount').value),
                costPerHour: parseFloat(document.getElementById('costPerHour').value),
                courtHours: selected,
                totalPrice: parseFloat(document.getElementById('booking-total').textContent.replace('$','').replace(',','')),
                timestamp: Timestamp.now(), adminEmail: user.email
            };
            const id = document.getElementById('booking-id').value;
            if (id) await updateDoc(getPublicDoc("bookings", id), data);
            else await addDoc(getPublicCollection("bookings"), data);
            window.closeModals();
        };

        document.getElementById('product-form').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('prod-name').value,
                stock: parseInt(document.getElementById('prod-stock').value),
                salePrice: parseFloat(document.getElementById('prod-suggested-price').textContent.replace('$','')),
                unitCost: parseFloat(document.getElementById('prod-unit-cost').value)
            };
            await addDoc(getPublicCollection("products"), data);
            e.target.reset(); document.getElementById('product-form-container').classList.add('is-hidden');
        };

        window.calculateProductPrices = () => {
            const cost = parseFloat(document.getElementById('prod-batch-cost').value) || 0;
            const qty = parseInt(document.getElementById('prod-batch-qty').value) || 1;
            const margin = parseFloat(document.getElementById('prod-profit-pct').value) || 40;
            const unit = cost / qty;
            const sugg = Math.ceil(unit * (1 + (margin / 100)));
            document.getElementById('prod-suggested-price').textContent = `$${sugg}`;
            document.getElementById('prod-unit-cost').value = unit;
        };
        
        document.getElementById('prod-batch-cost').oninput = window.calculateProductPrices;
        document.getElementById('prod-batch-qty').oninput = window.calculateProductPrices;
        document.getElementById('prod-profit-pct').oninput = window.calculateProductPrices;

        document.getElementById('config-form').onsubmit = async (e) => {
            e.preventDefault();
            const val = parseFloat(document.getElementById('config-court1-price').value);
            await setDoc(getPublicDoc("app_settings", "prices"), { court1Price: val }, { merge: true });
            appSettings.court1Price = val;
            alert("Precios actualizados AeroJump");
        };

        document.querySelectorAll('.menu-item').forEach(item => {
            item.onclick = (e) => {
                e.preventDefault();
                const view = e.currentTarget.dataset.view;
                document.querySelectorAll('.view-container').forEach(v => v.classList.add('is-hidden'));
                document.getElementById(`${view}-view`).classList.remove('is-hidden');
                if(view === 'caja') loadCajaData();
                document.getElementById('main-menu').classList.remove('is-open');
                document.getElementById('menu-overlay').classList.add('hidden');
            };
        });

        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value);
        };
        document.getElementById('logout-btn').onclick = () => signOut(auth);

        document.getElementById('add-product-btn').onclick = () => document.getElementById('product-form-container').classList.toggle('is-hidden');
        document.getElementById('cancel-product-btn').onclick = () => document.getElementById('product-form-container').classList.add('is-hidden');

        function loadCajaData() {
            onSnapshot(query(collection(db, "sales"), orderBy("timestamp", "desc")), (snap) => {
                const list = document.getElementById('caja-daily-list');
                list.innerHTML = ''; let total = 0;
                snap.forEach(d => {
                    const s = d.data(); total += s.total || 0;
                    list.innerHTML += `<div class="bg-white p-4 rounded-2xl shadow-sm border flex justify-between"><div><p class="font-black text-sm uppercase">${s.name} (x${s.qty})</p><p class="text-[10px] font-bold text-slate-400 uppercase">${s.day}</p></div><strong class="text-orange-600 font-black italic">$${(s.total || 0).toLocaleString()}</strong></div>`;
                });
                document.getElementById('caja-total-combined').textContent = `$${total.toLocaleString()}`;
            });
        }

        document.getElementById('sale-catalog-filter').oninput = (e) => renderSaleCatalog(e.target.value);

    </script>
</body>
</html>
