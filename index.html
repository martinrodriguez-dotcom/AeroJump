<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroJump Gualeguaych√∫ - Gesti√≥n v2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --color-violet: #7c3aed;
            --color-orange: #f97316;
            --color-slate: #1e293b;
        }

        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }

        /* Sistema de Modales - Ventana Extra con Scroll Interno */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(10px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        .modal.is-open { display: flex; }

        .modal-content {
            background: white;
            width: 100%;
            max-height: 90vh;
            border-radius: 2.5rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-header { padding: 1.5rem 2rem; border-bottom: 1px solid #e2e8f0; flex-shrink: 0; }
        .modal-body { padding: 2rem; overflow-y: auto; flex-grow: 1; }
        .modal-footer { padding: 1.5rem 2rem; border-top: 1px solid #e2e8f0; flex-shrink: 0; background: #f8fafc; }

        /* Botones de Horario con Info de Ocupaci√≥n */
        .time-slot {
            padding: 0.75rem;
            border-radius: 1rem;
            border: 2px solid #e2e8f0;
            text-align: center;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .time-slot.selected { background: var(--color-violet); border-color: var(--color-violet); color: white; }
        .time-slot.disabled { opacity: 0.3; cursor: not-allowed; background: #f1f5f9; }
        .time-slot .capacity-info { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; }

        /* Calendario */
        .day-cell { border-radius: 1rem; transition: all 0.2s; border: 2px solid #fff; background: white; min-height: 90px; cursor: pointer; }
        .day-cell:hover { border-color: var(--color-violet); transform: scale(1.03); z-index: 10; }
        .booking-count { background: var(--color-violet); color: white; border-radius: 99px; padding: 2px 8px; font-size: 0.65rem; font-weight: 900; }
        .booking-count.event { background: var(--color-orange); }

        /* UI Helpers */
        .is-hidden { display: none !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        #main-menu {
            position: fixed; top: 0; left: 0; height: 100vh; width: 280px;
            background: white; transform: translateX(-100%); transition: transform 0.3s ease;
            z-index: 500; box-shadow: 10px 0 30px rgba(0,0,0,0.05);
        }
        #main-menu.is-open { transform: translateX(0); }

        /* Animaciones */
        @keyframes jump { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-30px); } }
        .jumping-child { animation: jump 0.8s ease-in-out infinite; }
    </style>
</head>
<body>

    <!-- ============================================= -->
    <!-- CAPA DE AUTENTICACI√ìN                       -->
    <!-- ============================================= -->
    <div id="login-view" class="view-container flex items-center justify-center min-h-screen p-4">
        <div class="bg-white p-10 rounded-[3rem] shadow-2xl w-full max-w-sm text-center">
            <div class="inline-block p-5 bg-violet-100 rounded-3xl mb-6"><span class="text-4xl">üöÄ</span></div>
            <h2 class="text-3xl font-black text-slate-800 tracking-tighter uppercase italic mb-2">AeroJump</h2>
            <p class="text-slate-400 font-bold text-[10px] uppercase tracking-widest mb-10">Control de Administraci√≥n</p>
            <form id="login-form" class="space-y-4">
                <input type="email" id="login-email" placeholder="Email Admin" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-violet-500" required>
                <input type="password" id="login-password" placeholder="Contrase√±a" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-violet-500" required>
                <button type="submit" class="bg-violet-600 text-white w-full py-4 rounded-2xl font-black uppercase tracking-widest shadow-xl active:scale-95 transition-all">Ingresar</button>
            </form>
            <a href="#" id="show-register" class="block mt-8 text-[11px] text-violet-600 font-black uppercase italic hover:underline">Crear nueva cuenta</a>
        </div>
    </div>

    <div id="register-view" class="view-container flex items-center justify-center min-h-screen p-4 is-hidden">
        <div class="bg-white p-10 rounded-[3rem] shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-3xl font-black text-slate-800 tracking-tighter uppercase italic mb-8">Nueva Cuenta</h2>
            <form id="register-form" class="space-y-4">
                <input type="email" id="register-email" placeholder="Email" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-violet-500" required>
                <input type="password" id="register-password" placeholder="M√≠nimo 6 caracteres" class="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-violet-500" required>
                <button type="submit" class="bg-violet-600 text-white w-full py-4 rounded-2xl font-black uppercase tracking-widest shadow-xl">Registrar Admin</button>
            </form>
            <a href="#" id="show-login" class="block mt-8 text-[11px] text-violet-600 font-black uppercase italic">Volver al Login</a>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- CONTENEDOR PRINCIPAL                        -->
    <!-- ============================================= -->
    <div id="app-container" class="is-hidden">
        
        <header class="fixed top-0 left-0 right-0 bg-white/80 backdrop-blur-md shadow-sm p-4 flex justify-between items-center z-50 border-b border-slate-100">
            <div class="flex items-center gap-3">
                <button id="menu-btn" class="p-2 rounded-xl bg-slate-50 hover:bg-slate-100 transition-all">
                    <svg class="h-6 w-6 text-slate-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <h1 class="text-xl font-black text-slate-800 uppercase italic leading-none">AeroJump</h1>
            </div>
            <button id="header-sale-btn" class="bg-orange-500 text-white px-5 py-3 rounded-2xl font-black shadow-lg uppercase text-[10px]">Venta Kiosco</button>
        </header>

        <nav id="main-menu" class="p-8">
            <div class="border-b border-slate-100 pb-6 mb-6">
                <p id="user-email-display" class="font-black text-violet-700 truncate text-xs italic"></p>
                <button id="logout-btn" class="w-full text-left mt-4 text-[10px] font-black text-slate-400 uppercase hover:text-red-500">Cerrar Sesi√≥n</button>
            </div>
            <div class="space-y-2">
                <a href="#" class="menu-item block p-4 rounded-2xl font-bold text-slate-600 hover:bg-violet-50 hover:text-violet-700 transition-all" data-view="calendar">üóìÔ∏è Agenda de Saltos</a>
                <a href="#" class="menu-item block p-4 rounded-2xl font-bold text-slate-600 hover:bg-violet-50 hover:text-violet-700 transition-all" data-view="productos">ü•§ Stock Kiosco</a>
                <a href="#" class="menu-item block p-4 rounded-2xl font-bold text-slate-600 hover:bg-violet-50 hover:text-violet-700 transition-all" data-view="caja">üí∞ Arqueo de Caja</a>
                <a href="#" class="menu-item block p-4 rounded-2xl font-bold text-slate-600 hover:bg-violet-50 hover:text-violet-700 transition-all" data-view="configuracion">‚öôÔ∏è Configuraci√≥n</a>
            </div>
        </nav>
        <div id="menu-overlay" class="fixed inset-0 bg-slate-900/40 z-40 hidden"></div>

        <main class="pt-24 pb-12 px-4 max-w-6xl mx-auto">
            
            <!-- VISTA: CALENDARIO -->
            <div id="calendar-view" class="view-container">
                <div class="flex justify-between items-center bg-white p-5 rounded-[2.5rem] shadow-xl mb-8">
                    <button id="prev-month-btn" class="p-4 text-slate-300 font-bold">‚óÄ</button>
                    <h2 id="current-month-year" class="text-xl font-black text-violet-700 uppercase italic"></h2>
                    <button id="next-month-btn" class="p-4 text-slate-300 font-bold">‚ñ∂</button>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-3"></div>
            </div>

            <!-- VISTA: PRODUCTOS -->
            <div id="productos-view" class="view-container is-hidden">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-4xl font-black italic uppercase">Inventario</h2>
                    <button id="add-product-btn" class="bg-violet-600 text-white px-8 py-4 rounded-2xl font-black shadow-lg text-[10px]">NUEVO PRODUCTO</button>
                </div>
                <div id="product-form-container" class="bg-white p-8 rounded-[3rem] shadow-2xl mb-10 is-hidden border-4 border-violet-50">
                    <form id="product-form" class="grid grid-cols-1 md:grid-cols-3 gap-6 text-left">
                        <div class="md:col-span-2">
                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Nombre del Producto</label>
                            <input type="text" id="prod-name" class="w-full p-4 bg-slate-50 rounded-xl font-bold outline-none" required>
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Stock Inicial</label>
                            <input type="number" id="prod-stock" class="w-full p-4 bg-slate-50 rounded-xl font-bold outline-none" required min="0">
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Costo Bulto</label>
                            <input type="number" id="prod-batch-cost" class="w-full p-4 bg-violet-50 rounded-xl font-bold outline-none" required>
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Unidades x Bulto</label>
                            <input type="number" id="prod-batch-qty" class="w-full p-4 bg-slate-50 rounded-xl font-bold outline-none" required min="1" value="1">
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Margen (%)</label>
                            <input type="number" id="prod-profit-pct" class="w-full p-4 bg-orange-50 rounded-xl font-bold outline-none" value="40">
                        </div>
                        <div class="md:col-span-3 p-6 bg-slate-900 rounded-3xl flex justify-between items-center shadow-xl">
                            <div>
                                <span class="text-[10px] font-black text-green-400 uppercase block mb-1">Precio de Venta</span>
                                <span id="prod-suggested-price" class="text-4xl font-black text-white italic">$0</span>
                            </div>
                            <div class="flex gap-4">
                                <button type="button" id="cancel-product-btn" class="text-slate-400 font-bold uppercase text-xs">Cancelar</button>
                                <button type="submit" class="bg-green-600 text-white px-12 py-4 rounded-xl font-black uppercase text-xs shadow-lg">Guardar</button>
                            </div>
                        </div>
                        <input type="hidden" id="prod-unit-cost">
                    </form>
                </div>
                <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <!-- VISTA: CAJA -->
            <div id="caja-view" class="view-container is-hidden">
                <h2 class="text-4xl font-black mb-8 text-center uppercase italic">Arqueo Diario</h2>
                <div class="bg-slate-900 p-10 rounded-[3.5rem] text-white mb-10 shadow-2xl text-center">
                    <p class="text-[10px] font-black text-violet-400 uppercase mb-2 tracking-[0.3em]">Balance Total</p>
                    <p id="caja-total-combined" class="text-6xl font-black italic">$0</p>
                </div>
                <div id="caja-daily-list" class="space-y-4 text-left"></div>
            </div>

            <!-- VISTA: CONFIGURACI√ìN -->
            <div id="configuracion-view" class="view-container is-hidden max-w-md mx-auto">
                <div class="bg-white p-10 rounded-[3.5rem] shadow-2xl text-left">
                    <h2 class="text-2xl font-black mb-8 uppercase italic text-center">Ajustes AeroJump</h2>
                    <form id="config-form" class="space-y-6">
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase block mb-2">Costo Salto 1 Hora</label>
                            <input type="number" id="config-court1-price" class="w-full p-4 bg-slate-50 rounded-2xl font-bold text-xl text-violet-700 outline-none">
                        </div>
                        <button type="submit" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black uppercase italic border-b-4 border-black">Actualizar Tarifas</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- ============================================= -->
    <!-- SISTEMA DE MODALES (VENTANAS EXTRA)         -->
    <!-- ============================================= -->

    <!-- MODAL RESERVA CON SCROLL Y OCUPACI√ìN -->
    <div id="booking-modal" class="modal">
        <div class="modal-content max-w-3xl">
            <div class="modal-header text-left">
                <h3 id="booking-modal-title" class="text-3xl font-black text-violet-900 uppercase italic tracking-tighter">Reservar Salto</h3>
            </div>
            
            <form id="booking-form" class="flex flex-col overflow-hidden">
                <div class="modal-body custom-scrollbar text-left">
                    <input type="hidden" id="booking-id"><input type="hidden" id="booking-date">
                    
                    <div class="space-y-8">
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2 italic tracking-widest">Responsable del Turno</label>
                            <input type="text" id="teamName" class="w-full p-6 bg-slate-50 rounded-3xl font-black text-2xl italic outline-none focus:ring-4 focus:ring-violet-50" required placeholder="Nombre del cliente...">
                            <div id="teamName-suggestions" class="absolute z-50 bg-white shadow-2xl rounded-2xl is-hidden w-full max-w-md border"></div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="p-6 bg-slate-50 rounded-3xl border">
                                <label class="text-[10px] font-black uppercase text-slate-400 block mb-2">Cantidad de Personas</label>
                                <div class="flex items-center gap-4">
                                    <button type="button" onclick="adjustJumpers(-1)" class="w-12 h-12 bg-white rounded-xl font-black shadow-sm">-</button>
                                    <input type="number" id="peopleCount" class="w-20 text-center font-black text-3xl bg-transparent" value="1" min="1" max="30">
                                    <button type="button" onclick="adjustJumpers(1)" class="w-12 h-12 bg-white rounded-xl font-black shadow-sm">+</button>
                                </div>
                                <p class="text-[9px] font-bold text-slate-400 mt-3 uppercase">M√°ximo 30 por hora</p>
                            </div>
                            
                            <div class="p-6 bg-violet-50 rounded-3xl border border-violet-100 flex flex-col justify-center">
                                <span class="text-[10px] font-black text-violet-400 uppercase mb-1">Precio x Hora</span>
                                <input type="number" id="costPerHour" class="bg-transparent font-black text-3xl text-violet-700 outline-none">
                            </div>
                        </div>

                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2 block mb-4 italic tracking-widest">Seleccionar Horarios (Capacidad: 30)</label>
                            <div id="court-hours-list" class="grid grid-cols-3 sm:grid-cols-5 gap-3">
                                <!-- Botones de hora din√°micos aqu√≠ -->
                            </div>
                        </div>

                        <div class="flex justify-between items-center p-6 bg-orange-50 rounded-3xl border border-orange-100">
                            <div class="flex items-center gap-4 text-left">
                                <input type="checkbox" id="rentGrill" class="w-6 h-6 rounded-lg accent-orange-600">
                                <span class="font-black text-orange-800 text-sm uppercase italic">¬øIncluye Combo Especial?</span>
                            </div>
                            <input type="number" id="grillCost" class="w-24 p-3 rounded-xl bg-white font-black text-center" placeholder="$0">
                        </div>
                    </div>
                </div>

                <div class="modal-footer flex flex-col sm:flex-row justify-between items-center gap-6 text-center sm:text-left">
                    <div class="text-left">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em]">Monto Total</span>
                        <p id="booking-total" class="text-5xl font-black text-violet-700 italic tracking-tighter leading-none">$0</p>
                    </div>
                    <div class="flex gap-4 w-full sm:w-auto">
                        <button type="button" onclick="closeModals()" class="flex-1 px-8 py-5 font-black text-slate-400 uppercase text-xs">Cerrar</button>
                        <button type="submit" class="flex-2 bg-violet-600 text-white px-12 py-5 rounded-2xl font-black uppercase text-sm shadow-xl shadow-violet-200 active:scale-95 transition-all">Confirmar Salto</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL VENTAS MULTIPRODUCTO -->
    <div id="sale-modal" class="modal">
        <div class="modal-content max-w-3xl">
            <div class="modal-header text-left">
                <h3 class="text-3xl font-black text-orange-600 uppercase italic tracking-tighter">Venta de Kiosco</h3>
            </div>
            <div id="sale-cart-list" class="modal-body custom-scrollbar bg-slate-50 border-y py-4 text-left">
                <p id="empty-cart-msg" class="text-center text-slate-300 font-black uppercase text-xs py-10">El carrito est√° vac√≠o</p>
            </div>
            <div class="px-8 py-4 bg-white text-left">
                <input type="text" id="sale-catalog-filter" class="w-full p-4 bg-slate-50 rounded-2xl font-bold border-2 border-slate-100 outline-none focus:border-orange-500" placeholder="üîç Buscar producto...">
            </div>
            <div id="sale-catalog-grid" class="modal-body custom-scrollbar grid grid-cols-2 sm:grid-cols-4 gap-4 pb-10"></div>
            
            <div class="modal-footer">
                <div class="flex justify-between items-center">
                    <div class="text-left">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Total a Pagar</span>
                        <span id="sale-total-display" class="text-6xl font-black text-orange-600 italic tracking-tighter leading-none">$0</span>
                    </div>
                    <button id="confirm-sale-btn" class="bg-orange-500 text-white px-14 py-6 rounded-2xl font-black uppercase shadow-xl disabled:opacity-20 transition-all active:scale-95" disabled>Finalizar Venta</button>
                </div>
            </div>
        </div>
    </div>

    <!-- OVERLAY DE CARGA -->
    <div id="message-overlay" class="modal bg-white/95 backdrop-blur-md">
        <div class="flex flex-col items-center justify-center min-h-screen text-center p-10">
            <svg width="120" height="120" viewBox="0 0 100 100" class="mb-8">
                <path d="M10 80 Q 50 80 90 80" stroke="#7c3aed" stroke-width="6" fill="none" stroke-linecap="round" class="trampoline-line"/>
                <g class="jumping-child">
                    <circle cx="50" cy="40" r="8" fill="#f97316"/>
                    <line x1="50" y1="48" x2="50" y2="65" stroke="#1e293b" stroke-width="4"/>
                </g>
            </svg>
            <p id="message-text" class="text-xl font-black text-slate-800 uppercase italic tracking-tighter">Sincronizando AeroJump...</p>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- L√ìGICA DE LA APLICACI√ìN                     -->
    <!-- ============================================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, updateDoc, deleteDoc, collection, query, where, onSnapshot, getDocs, Timestamp, orderBy, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBz0V2ieSXehafKWRNQprb951NVN5FvBD4",
            authDomain: "aerojump-841fb.firebaseapp.com",
            projectId: "aerojump-841fb",
            storageBucket: "aerojump-841fb.firebasestorage.app",
            messagingSenderId: "68080726646",
            appId: "1:68080726646:web:a830613a1278871d416557"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "aerojump-gualeguaychu";

        // HELPERS DE RUTAS FIREBASE (REGLA 1)
        const getPublicCollection = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);
        const getPublicDoc = (name, id) => doc(db, 'artifacts', appId, 'public', 'data', name, id);

        // ESTADO GLOBAL
        let user = null;
        let allMonthBookings = [];
        let allProducts = [];
        let saleCart = [];
        let appSettings = { court1Price: 5000, grillPrice: 2000, eventPrice: 10000 };
        const OPERATING_HOURS = [9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23];
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        let currentMonthDate = new Date();
        const MAX_CAPACITY = 30;

        // ELEMENTOS DOM
        const loginView = document.getElementById('login-view');
        const appContainer = document.getElementById('app-container');
        const calendarGrid = document.getElementById('calendar-grid');
        const currentMonthYearEl = document.getElementById('current-month-year');
        const bookingModal = document.getElementById('booking-modal');
        const courtHoursList = document.getElementById('court-hours-list');

        // INICIO Y AUTH
        onAuthStateChanged(auth, async (u) => {
            if (u) {
                user = u;
                document.getElementById('user-email-display').textContent = u.email;
                loginView.classList.add('is-hidden');
                document.getElementById('register-view').classList.add('is-hidden');
                appContainer.classList.remove('is-hidden');
                await initApp();
            } else {
                loginView.classList.remove('is-hidden');
                appContainer.classList.add('is-hidden');
            }
        });

        async function initApp() {
            await loadSettings();
            syncBookings();
            syncProducts();
        }

        // --- L√ìGICA DE OCUPACI√ìN ---
        function getOccupancyForDay(dateStr) {
            const occupancy = {};
            OPERATING_HOURS.forEach(h => occupancy[h] = 0);
            allMonthBookings.filter(b => b.day === dateStr).forEach(b => {
                const count = parseInt(b.peopleCount) || 0;
                b.courtHours.forEach(h => {
                    if (occupancy[h] !== undefined) occupancy[h] += count;
                });
            });
            return occupancy;
        }

        function renderTimeSlots(dateStr, editingId = null) {
            const occupancy = getOccupancyForDay(dateStr);
            const currentBooking = allMonthBookings.find(b => b.id === editingId);
            const selectedHours = currentBooking ? currentBooking.courtHours : [];
            
            if (currentBooking) {
                const myCount = parseInt(currentBooking.peopleCount) || 0;
                selectedHours.forEach(h => occupancy[h] -= myCount);
            }

            courtHoursList.innerHTML = '';
            OPERATING_HOURS.forEach(h => {
                const currentJumpers = occupancy[h];
                const available = MAX_CAPACITY - currentJumpers;
                const isFull = available <= 0;
                
                const btn = document.createElement('button');
                btn.type = "button";
                btn.className = `time-slot ${isFull ? 'disabled' : ''} ${selectedHours.includes(h) ? 'selected' : ''}`;
                btn.innerHTML = `
                    <span class="font-black text-sm">${h}:00</span>
                    <span class="capacity-info ${available < 5 ? 'text-orange-600' : 'text-slate-400'}">
                        ${available} libres
                    </span>
                `;

                if (!isFull) {
                    btn.onclick = () => {
                        btn.classList.toggle('selected');
                        updateBookingPrice();
                    };
                }
                courtHoursList.appendChild(btn);
            });
        }

        // --- GESTI√ìN DE TURNOS ---
        async function showBookingModal(dateStr, booking = null) {
            const form = document.getElementById('booking-form');
            form.reset();
            document.getElementById('booking-date').value = dateStr;
            document.getElementById('booking-id').value = booking ? booking.id : '';
            document.getElementById('teamName').value = booking ? booking.teamName : '';
            document.getElementById('peopleCount').value = booking ? booking.peopleCount : 1;
            document.getElementById('costPerHour').value = appSettings.court1Price;
            
            renderTimeSlots(dateStr, booking?.id);
            updateBookingPrice();
            bookingModal.classList.add('is-open');
        }

        function updateBookingPrice() {
            const h = courtHoursList.querySelectorAll('.time-slot.selected').length;
            const p = parseFloat(document.getElementById('costPerHour').value) || 0;
            const extra = document.getElementById('rentGrill').checked ? parseFloat(document.getElementById('grillCost').value || 0) : 0;
            document.getElementById('booking-total').textContent = `$${(h * p + extra).toLocaleString()}`;
        }

        // --- CALENDARIO ---
        function syncBookings() {
            const monthYear = `${currentMonthDate.getFullYear()}-${String(currentMonthDate.getMonth() + 1).padStart(2, '0')}`;
            const qBk = query(getPublicCollection("bookings"), where("monthYear", "==", monthYear));
            onSnapshot(qBk, (snap) => {
                allMonthBookings = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderCalendar();
            });
        }

        function renderCalendar() {
            calendarGrid.innerHTML = '';
            currentMonthYearEl.textContent = `${monthNames[currentMonthDate.getMonth()]} ${currentMonthDate.getFullYear()}`;
            const firstDay = new Date(currentMonthDate.getFullYear(), currentMonthDate.getMonth(), 1).getDay();
            const lastDate = new Date(currentMonthDate.getFullYear(), currentMonthDate.getMonth() + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                const d = document.createElement('div'); d.className = 'day-cell opacity-0 pointer-events-none'; calendarGrid.appendChild(d);
            }
            for (let i = 1; i <= lastDate; i++) {
                const ds = `${currentMonthDate.getFullYear()}-${String(currentMonthDate.getMonth() + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const bks = allMonthBookings.filter(b => b.day === ds);
                const cell = document.createElement('div');
                cell.className = 'day-cell p-3 flex flex-col justify-between text-left';
                cell.innerHTML = `<span class="font-black italic">${i}</span>`;
                if (bks.length > 0) {
                    const badge = document.createElement('div');
                    badge.className = `booking-count ${bks.some(b => b.type === 'event') ? 'event' : ''}`;
                    badge.textContent = bks.length;
                    cell.appendChild(badge);
                }
                cell.onclick = () => showBookingModal(ds);
                calendarGrid.appendChild(cell);
            }
        }

        // --- PRODUCTOS ---
        function syncProducts() {
            onSnapshot(getPublicCollection("products"), (snap) => {
                allProducts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderProducts();
            });
        }

        function renderProducts() {
            const list = document.getElementById('product-list');
            list.innerHTML = '';
            allProducts.forEach(p => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-3xl shadow-sm border flex flex-col gap-4 text-left';
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-black italic uppercase text-slate-800 text-lg leading-tight">${p.name}</h4>
                            <span class="text-[9px] font-black uppercase text-violet-500">Stock: ${p.stock} un.</span>
                        </div>
                        <strong class="text-2xl font-black text-violet-600 italic">$${p.salePrice}</strong>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="window.openEditProduct('${p.id}')" class="bg-slate-50 text-slate-600 p-2 rounded-xl text-[8px] font-black uppercase">‚úèÔ∏è Editar</button>
                        <button onclick="window.deleteProduct('${p.id}')" class="bg-orange-50 text-orange-500 p-2 rounded-xl text-[8px] font-black uppercase">üóëÔ∏è Borrar</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        // --- PRODUCT CALCULATIONS ---
        function calculateProductPrices() {
            const cost = parseFloat(document.getElementById('prod-batch-cost').value) || 0;
            const qty = parseInt(document.getElementById('prod-batch-qty').value) || 1;
            const margin = parseFloat(document.getElementById('prod-profit-pct').value) || 40;
            const unit = cost / qty;
            const sugg = Math.ceil(unit * (1 + (margin / 100)));
            document.getElementById('prod-suggested-price').textContent = `$${sugg}`;
            document.getElementById('prod-unit-cost').value = unit;
        }

        // --- SETTINGS ---
        async function loadSettings() {
            const d = await getDoc(getPublicDoc("app_settings", "prices"));
            if (d.exists()) {
                appSettings = d.data();
                document.getElementById('config-court1-price').value = appSettings.court1Price;
            }
        }

        // --- UI ACTIONS ---
        window.closeModals = () => { document.querySelectorAll('.modal').forEach(m => m.classList.remove('is-open')); };
        window.toggleMenu = () => { 
            document.getElementById('main-menu').classList.toggle('is-open');
            document.getElementById('menu-overlay').classList.toggle('hidden');
        };
        window.adjustJumpers = (val) => {
            const input = document.getElementById('peopleCount');
            let n = parseInt(input.value) + val;
            if (n < 1) n = 1; if (n > 30) n = 30;
            input.value = n;
            renderTimeSlots(document.getElementById('booking-date').value, document.getElementById('booking-id').value);
            updateBookingPrice();
        };

        window.prevMonth = () => { currentMonthDate.setMonth(currentMonthDate.getMonth() - 1); syncBookings(); };
        window.nextMonth = () => { currentMonthDate.setMonth(currentMonthDate.getMonth() + 1); syncBookings(); };

        // --- SUBMIT HANDLERS ---
        document.getElementById('booking-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            
            const selected = Array.from(courtHoursList.querySelectorAll('.time-slot.selected')).map(el => parseInt(el.querySelector('span').textContent));
            if (selected.length === 0) { alert("Elige un horario"); btn.disabled = false; return; }

            const data = {
                teamName: document.getElementById('teamName').value,
                day: document.getElementById('booking-date').value,
                monthYear: document.getElementById('booking-date').value.substring(0, 7),
                peopleCount: parseInt(document.getElementById('peopleCount').value),
                costPerHour: parseFloat(document.getElementById('costPerHour').value),
                courtHours: selected,
                totalPrice: parseFloat(document.getElementById('booking-total').textContent.replace('$','').replace(',','')),
                timestamp: Timestamp.now(),
                adminEmail: user.email
            };

            try {
                const id = document.getElementById('booking-id').value;
                if (id) await updateDoc(getPublicDoc("bookings", id), data);
                else await addDoc(getPublicCollection("bookings"), data);
                closeModals();
            } catch (err) { alert(err.message); } finally { btn.disabled = false; }
        };

        document.getElementById('product-form').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('prod-name').value,
                stock: parseInt(document.getElementById('prod-stock').value),
                salePrice: parseFloat(document.getElementById('prod-suggested-price').textContent.replace('$','')),
                unitCost: parseFloat(document.getElementById('prod-unit-cost').value)
            };
            await addDoc(getPublicCollection("products"), data);
            e.target.reset(); document.getElementById('product-form-container').classList.add('is-hidden');
        };

        document.getElementById('config-form').onsubmit = async (e) => {
            e.preventDefault();
            const val = parseFloat(document.getElementById('config-court1-price').value);
            await setDoc(getPublicDoc("app_settings", "prices"), { court1Price: val }, { merge: true });
            appSettings.court1Price = val;
            alert("Ajustes guardados");
        };

        // --- VIEW NAVIGATION ---
        document.querySelectorAll('.menu-item').forEach(item => {
            item.onclick = (e) => {
                e.preventDefault();
                const view = e.currentTarget.dataset.view;
                document.querySelectorAll('.view-container').forEach(v => v.classList.add('is-hidden'));
                document.getElementById(`${view}-view`).classList.remove('is-hidden');
                window.toggleMenu();
            };
        });

        document.getElementById('logout-btn').onclick = () => signOut(auth);
        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value);
        };

        window.deleteProduct = async (id) => { if(confirm("¬øBorrar?")) await deleteDoc(getPublicDoc("products", id)); };
        
    </script>
</body>
</html>
