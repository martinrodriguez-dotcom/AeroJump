<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroJump Gualeguaych√∫ - Gesti√≥n Integral v2026</title>
    
    <!-- Frameworks y Fuentes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#7c3aed">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <style>
        :root {
            --color-violet: #7c3aed;
            --color-violet-hover: #6d28d9;
            --color-orange: #f97316;
            --color-slate: #0f172a; 
            --text-main: #0f172a;
            --text-muted: #334155; 
            --bg-main: #f1f5f9;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-main); 
            color: var(--text-main); 
            overflow-x: hidden;
        }

        /* Sistema de Modales - Ventana Extra */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(2, 6, 23, 0.92); 
            backdrop-filter: blur(15px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            animation: modalFadeIn 0.3s ease-out;
        }
        .modal.is-open { display: flex; }

        .modal-content {
            background: white;
            width: 100%;
            max-height: 94vh;
            border-radius: 2.5rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            border: 3px solid #e2e8f0;
        }

        .modal-header { padding: 1.25rem 2rem; border-bottom: 2px solid #f1f5f9; flex-shrink: 0; }
        .modal-body { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
        .modal-footer { padding: 1.25rem 2rem; border-top: 2px solid #f1f5f9; flex-shrink: 0; background: #ffffff; }

        @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.97); } to { opacity: 1; transform: scale(1); } }

        /* Botones de Horario con Info de Ocupaci√≥n */
        .time-slot {
            padding: 0.8rem;
            border-radius: 1.25rem;
            border: 2px solid #94a3b8; 
            text-align: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            cursor: pointer;
            background: white;
        }
        .time-slot:hover:not(.disabled) { border-color: var(--color-violet); transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .time-slot.selected { background: var(--color-violet); border-color: var(--color-violet); color: white; transform: scale(1.05); }
        .time-slot.disabled { opacity: 0.2; cursor: not-allowed; background: #cbd5e1; border-style: dashed; }
        .time-slot .capacity-info { font-size: 0.65rem; font-weight: 900; text-transform: uppercase; margin-top: 2px; }

        /* Tarjetas de Producto en Venta */
        .product-sale-card {
            background: white;
            border: 2px solid #f1f5f9;
            border-radius: 2rem;
            padding: 1.25rem;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .product-sale-card:hover {
            border-color: var(--color-violet);
            transform: translateY(-4px);
            box-shadow: 0 15px 20px -5px rgba(124, 58, 237, 0.15);
        }

        /* Calendario */
        .day-cell { 
            border-radius: 1.25rem; 
            transition: all 0.2s; 
            border: 2px solid #e2e8f0; 
            background: white; 
            min-height: 105px; 
            cursor: pointer; 
        }
        .day-cell:hover { border-color: var(--color-violet); transform: scale(1.05); z-index: 10; box-shadow: 0 20px 25px -5px rgba(124, 58, 237, 0.1); }
        .booking-count { background: var(--color-violet); color: white; border-radius: 99px; padding: 2px 10px; font-size: 0.7rem; font-weight: 900; }
        .booking-count.event { background: var(--color-orange); }

        /* Navegaci√≥n Lateral */
        #main-menu {
            position: fixed; top: 0; left: 0; height: 100vh; width: 300px;
            background: white; transform: translateX(-100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 500; box-shadow: 20px 0 50px rgba(0,0,0,0.25);
        }
        #main-menu.is-open { transform: translateX(0); }

        /* Utilitarios de Scroll y Capas */
        .is-hidden { display: none !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Switch Premium */
        .switch { position: relative; display: inline-block; width: 48px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #94a3b8; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--color-violet); }
        input:checked + .slider:before { transform: translateX(24px); }

        @keyframes jump { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-35px); } }
        .jumping-child { animation: jump 0.8s ease-in-out infinite; }
    </style>
</head>
<body>

    <!-- ============================================= -->
    <!-- 1. CAPA DE ACCESO (LOGIN)                    -->
    <!-- ============================================= -->
    <div id="login-view" class="view-container flex items-center justify-center min-h-screen p-4">
        <div class="bg-white p-10 rounded-[3.5rem] shadow-2xl w-full max-w-sm text-center border-4 border-slate-50">
            <div class="inline-block p-6 bg-violet-100 rounded-[2.5rem] mb-6 shadow-inner"><span class="text-5xl">üöÄ</span></div>
            <h2 class="text-4xl font-black text-slate-900 tracking-tighter uppercase italic mb-2 leading-none">AeroJump</h2>
            <p class="text-slate-500 font-bold text-[10px] uppercase tracking-widest mb-10 italic">Management v2026</p>
            <form id="login-form" class="space-y-4">
                <input type="email" id="login-email" placeholder="Email Administrativo" class="w-full p-5 bg-slate-50 rounded-2xl font-black border-2 border-slate-100 focus:ring-8 focus:ring-violet-50 outline-none transition-all placeholder:text-slate-300" required>
                <input type="password" id="login-password" placeholder="Contrase√±a" class="w-full p-5 bg-slate-50 rounded-2xl font-black border-2 border-slate-100 focus:ring-8 focus:ring-violet-50 outline-none transition-all placeholder:text-slate-300" required>
                <button type="submit" class="bg-violet-600 text-white w-full py-5 rounded-2xl font-black uppercase tracking-widest shadow-2xl active:scale-95 transition-all text-sm border-b-8 border-violet-800 italic">Ingresar</button>
            </form>
            <a href="#" id="show-register" class="block mt-8 text-[11px] text-violet-700 font-black uppercase italic hover:underline tracking-tight">Crear cuenta de administrador</a>
        </div>
    </div>

    <div id="register-view" class="view-container flex items-center justify-center min-h-screen p-4 is-hidden">
        <div class="bg-white p-10 rounded-[3.5rem] shadow-2xl w-full max-w-sm text-center border-4 border-slate-50">
            <h2 class="text-3xl font-black text-slate-900 tracking-tighter uppercase italic mb-8">Nueva Cuenta</h2>
            <form id="register-form" class="space-y-4">
                <input type="email" id="register-email" placeholder="Email" class="w-full p-5 bg-slate-50 rounded-2xl font-bold border-2 border-slate-100 outline-none focus:ring-4 focus:ring-violet-50" required>
                <input type="password" id="register-password" placeholder="Contrase√±a (m√≠n. 6)" class="w-full p-5 bg-slate-50 rounded-2xl font-bold border-2 border-slate-100 outline-none focus:ring-4 focus:ring-violet-50" required>
                <button type="submit" class="bg-violet-600 text-white w-full py-5 rounded-2xl font-black uppercase tracking-widest shadow-xl italic text-sm">Registrar Admin</button>
            </form>
            <a href="#" id="show-login" class="block mt-8 text-[11px] text-violet-700 font-black uppercase italic hover:underline">Volver al Login</a>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- 2. CONTENEDOR PRINCIPAL                      -->
    <!-- ============================================= -->
    <div id="app-container" class="is-hidden">
        
        <header class="fixed top-0 left-0 right-0 bg-white/95 backdrop-blur-md shadow-md p-4 flex justify-between items-center z-50 border-b-2 border-slate-100">
            <div class="flex items-center gap-3">
                <button id="menu-btn" class="p-3 rounded-2xl bg-slate-100 hover:bg-slate-200 transition-all active:scale-90 border-2 border-slate-200 shadow-sm">
                    <svg class="h-7 w-7 text-slate-900" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3.5"><path d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <div class="leading-none text-left">
                    <h1 class="text-2xl font-black text-slate-900 uppercase italic tracking-tighter leading-none">AeroJump</h1>
                    <span class="text-[9px] font-black text-violet-600 uppercase tracking-widest leading-none">v2026 Admin</span>
                </div>
            </div>
            <button id="header-sale-btn" class="bg-orange-600 text-white px-8 py-3 rounded-2xl font-black shadow-lg uppercase text-[10px] active:scale-90 transition-all hover:bg-orange-700 border-b-4 border-orange-800 italic">Nueva Venta</button>
        </header>

        <nav id="main-menu" class="p-8 flex flex-col">
            <div class="border-b-2 border-slate-100 pb-6 mb-8 text-left leading-none">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-3 tracking-widest italic font-black">Sesi√≥n AeroJump</p>
                <p id="user-email-display" class="font-black text-violet-700 truncate text-xs italic mb-4 leading-none"></p>
                <button id="logout-btn" class="text-[11px] font-black text-slate-500 uppercase hover:text-red-600 transition-colors italic tracking-widest">Cerrar Sesi√≥n üîí</button>
            </div>
            <div class="space-y-3">
                <button class="menu-item flex items-center gap-4 w-full text-left p-5 rounded-2xl font-black text-slate-800 hover:bg-violet-50 hover:text-violet-800 transition-all text-xs uppercase italic tracking-widest border-2 border-transparent hover:border-violet-100 shadow-sm" data-view="calendar"><span>üóìÔ∏è</span> Agenda de Saltos</button>
                <button class="menu-item flex items-center gap-4 w-full text-left p-5 rounded-2xl font-black text-slate-800 hover:bg-violet-50 hover:text-violet-800 transition-all text-xs uppercase italic tracking-widest border-2 border-transparent hover:border-violet-100 shadow-sm" data-view="productos"><span>ü•§</span> Stock Kiosco</button>
                <button class="menu-item flex items-center gap-4 w-full text-left p-5 rounded-2xl font-black text-slate-800 hover:bg-violet-50 hover:text-violet-800 transition-all text-xs uppercase italic tracking-widest border-2 border-transparent hover:border-violet-100 shadow-sm" data-view="caja"><span>üí∞</span> Arqueo de Caja</button>
                <button class="menu-item flex items-center gap-4 w-full text-left p-5 rounded-2xl font-black text-slate-800 hover:bg-violet-50 hover:text-violet-800 transition-all text-xs uppercase italic tracking-widest border-2 border-transparent hover:border-violet-100 shadow-sm" data-view="stats"><span>üìä</span> Estad√≠sticas</button>
                <button class="menu-item flex items-center gap-4 w-full text-left p-5 rounded-2xl font-black text-slate-800 hover:bg-violet-50 hover:text-violet-800 transition-all text-xs uppercase italic tracking-widest border-2 border-transparent hover:border-violet-100 shadow-sm" data-view="configuracion"><span>‚öôÔ∏è</span> Tarifas Maestro</button>
            </div>
        </nav>
        <div id="menu-overlay" class="fixed inset-0 bg-slate-950/70 z-40 hidden"></div>

        <main class="pt-32 pb-12 px-4 max-w-6xl mx-auto text-left">
            
            <!-- VISTA: CALENDARIO -->
            <div id="calendar-view" class="view-container">
                <div class="flex justify-between items-center bg-white p-6 rounded-[2.5rem] shadow-xl mb-10 border-4 border-slate-50 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-10 opacity-[0.03] text-8xl font-black italic select-none">AGENDA</div>
                    <button id="prev-month-btn" class="p-4 text-slate-400 font-black hover:text-violet-700 transition-all text-2xl active:scale-90">‚óÄ</button>
                    <h2 id="current-month-year" class="text-3xl font-black text-violet-800 uppercase italic tracking-tighter text-center leading-none"></h2>
                    <button id="next-month-btn" class="p-4 text-slate-400 font-black hover:text-violet-700 transition-all text-2xl active:scale-90">‚ñ∂</button>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-4"></div>
            </div>

            <!-- VISTA: PRODUCTOS (STOCK) -->
            <div id="productos-view" class="view-container is-hidden">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-12 text-left gap-6">
                    <div>
                        <h2 class="text-5xl font-black italic uppercase text-slate-900 leading-none tracking-tighter">Inventario</h2>
                        <p class="text-slate-500 font-bold text-[11px] uppercase mt-2 italic tracking-[0.2em] font-black">Control Maestro de Mercader√≠a</p>
                    </div>
                    <button id="add-product-btn" class="bg-violet-700 text-white px-10 py-5 rounded-[2rem] font-black shadow-2xl text-[11px] active:scale-95 transition-all border-b-8 border-violet-900">+ AGREGAR ART√çCULO</button>
                </div>
                
                <div id="product-form-container" class="bg-white p-10 rounded-[3rem] shadow-2xl mb-12 is-hidden border-4 border-violet-50 text-left relative overflow-hidden">
                    <h3 class="text-2xl font-black text-violet-900 mb-8 uppercase italic tracking-tighter">‚ú® Registro de Producto</h3>
                    <form id="product-form" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="md:col-span-2">
                            <label class="text-[10px] font-black uppercase text-slate-600 ml-2 italic">Nombre Comercial</label>
                            <input type="text" id="prod-name" placeholder="Ej: Bebida 500ml" class="w-full p-5 bg-slate-50 rounded-2xl font-black text-xl italic border-2 border-slate-100 focus:ring-8 focus:ring-violet-50 outline-none transition-all" required>
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-600 ml-2 italic">Stock Inicial</label>
                            <input type="number" id="prod-stock" class="w-full p-5 bg-slate-50 rounded-2xl font-black text-xl italic border-2 border-slate-100 focus:ring-8 focus:ring-violet-50 outline-none text-center" required min="0">
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-600 ml-2 italic">Costo de Bulto ($)</label>
                            <input type="number" id="prod-batch-cost" class="w-full p-5 bg-violet-50 rounded-2xl font-black text-2xl text-violet-700 border-2 border-violet-100 outline-none focus:ring-8 focus:ring-violet-50" required step="0.01">
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-600 ml-2 italic">Unidades por Bulto</label>
                            <input type="number" id="prod-batch-qty" class="w-full p-5 bg-slate-50 rounded-2xl font-black text-xl border-2 border-slate-100 outline-none text-center focus:ring-8 focus:ring-violet-50" required min="1" value="1">
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-600 ml-2 italic">Margen de Ganancia (%)</label>
                            <input type="number" id="prod-profit-pct" class="w-full p-5 bg-orange-50 rounded-2xl font-black text-xl border-2 border-orange-100 outline-none text-center focus:ring-8 focus:ring-orange-50" value="40">
                        </div>
                        <div class="md:col-span-3 p-10 bg-slate-950 rounded-[3.5rem] flex flex-col md:flex-row justify-between items-center gap-10 shadow-2xl border-t-[10px] border-violet-500">
                            <div class="text-left leading-none">
                                <span class="text-[11px] font-black text-green-400 uppercase block mb-3 italic tracking-widest">Precio de Venta Sugerido</span>
                                <span id="prod-suggested-price" class="text-7xl font-black text-white italic tracking-tighter">$0</span>
                            </div>
                            <div class="flex gap-4 w-full md:w-auto">
                                <button type="button" id="cancel-product-btn" class="flex-1 px-8 py-5 text-slate-500 font-black uppercase text-[10px] italic">Descartar</button>
                                <button type="submit" class="flex-2 bg-green-600 text-white px-14 py-7 rounded-3xl font-black uppercase text-xs shadow-xl active:scale-95 transition-all border-b-8 border-green-900 italic tracking-widest">Confirmar Alta</button>
                            </div>
                        </div>
                        <input type="hidden" id="prod-unit-cost">
                    </form>
                </div>
                <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10"></div>
            </div>

            <!-- VISTA: CAJA -->
            <div id="caja-view" class="view-container is-hidden">
                <h2 class="text-5xl font-black mb-12 text-center uppercase italic text-slate-900 tracking-tighter">Arqueo Diario</h2>
                <div class="bg-slate-950 p-16 rounded-[4.5rem] text-white mb-12 shadow-2xl text-center relative overflow-hidden border-t-[14px] border-violet-600">
                    <p class="text-[12px] font-black text-violet-400 uppercase mb-4 tracking-[0.4em] italic leading-none">Total Recaudado AeroJump</p>
                    <p id="caja-total-combined" class="text-[7rem] font-black italic tracking-tighter text-white leading-none">$0</p>
                </div>
                <div id="caja-daily-list" class="space-y-6"></div>
            </div>

            <!-- VISTA: CONFIGURACI√ìN -->
            <div id="configuracion-view" class="view-container is-hidden max-w-md mx-auto">
                <div class="bg-white p-12 rounded-[4rem] shadow-2xl border-4 border-slate-100 text-left">
                    <h2 class="text-3xl font-black mb-10 uppercase italic text-center text-slate-900 tracking-tighter leading-none">Configuraci√≥n de Tarifas</h2>
                    <form id="config-form" class="space-y-10">
                        <div>
                            <label class="block text-[11px] font-black text-slate-600 uppercase mb-3 ml-2 italic tracking-widest font-black">Costo Salto 1 Hora ($)</label>
                            <input type="number" id="config-court1-price" class="w-full p-6 bg-slate-50 rounded-[2rem] font-black text-4xl text-violet-700 outline-none border-2 border-slate-100 focus:ring-8 focus:ring-violet-50 transition-all shadow-inner text-center">
                        </div>
                        <button type="submit" class="w-full bg-slate-950 text-white py-7 rounded-[2.5rem] font-black uppercase italic border-b-8 border-black active:scale-95 transition-all shadow-2xl tracking-widest">Actualizar Valores</button>
                    </form>
                </div>
            </div>

            <!-- VISTA: ESTAD√çSTICAS -->
            <div id="stats-view" class="view-container is-hidden text-left">
                <h2 class="text-5xl font-black mb-12 uppercase italic text-slate-900 tracking-tighter leading-none">Rankings AeroJump</h2>
                <div id="stats-list" class="space-y-4"></div>
            </div>
        </main>
    </div>

    <!-- ============================================= -->
    <!-- SISTEMA DE MODALES (VENTANAS EXTRA)         -->
    <!-- ============================================= -->

    <!-- MODAL RESERVA -->
    <div id="booking-modal" class="modal">
        <div class="modal-content max-w-3xl">
            <div class="modal-header text-left bg-slate-900 text-white border-none p-10 leading-none">
                <h3 id="booking-modal-title" class="text-4xl font-black uppercase italic tracking-tighter leading-none">Reservar Salto</h3>
                <p class="text-[10px] text-violet-400 font-bold uppercase mt-2 tracking-widest italic">AeroJump Gualeguaych√∫</p>
            </div>
            <form id="booking-form" class="flex flex-col overflow-hidden text-left">
                <div class="modal-body custom-scrollbar bg-white">
                    <input type="hidden" id="booking-id"><input type="hidden" id="booking-date">
                    <div class="space-y-12">
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-600 ml-4 italic tracking-widest block mb-2">Responsable / Cliente</label>
                            <input type="text" id="teamName" class="w-full p-7 bg-slate-50 rounded-[2.5rem] font-black text-4xl italic outline-none focus:ring-[12px] focus:ring-violet-50 border-2 border-slate-100 transition-all tracking-tighter" required placeholder="Nombre Completo..." autocomplete="off">
                            <div id="teamName-suggestions" class="absolute z-50 bg-white shadow-2xl rounded-3xl is-hidden w-full max-w-md border-2 border-slate-100 overflow-hidden mt-3"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                            <div class="p-8 bg-slate-50 rounded-[3rem] border-2 border-slate-100 text-center relative overflow-hidden group">
                                <label class="text-[11px] font-black uppercase text-slate-600 block mb-5 italic tracking-widest font-black">Cantidad de Personas</label>
                                <div class="flex items-center justify-center gap-10">
                                    <button type="button" onclick="window.adjustJumpers(-1)" class="w-20 h-20 bg-white border-2 border-slate-200 rounded-[2rem] font-black shadow-xl text-3xl active:scale-90 transition-all hover:bg-slate-50">-</button>
                                    <input type="number" id="peopleCount" class="w-24 text-center font-black text-6xl bg-transparent outline-none italic leading-none text-slate-900" value="1" min="1" max="30">
                                    <button type="button" onclick="window.adjustJumpers(1)" class="w-20 h-20 bg-white border-2 border-slate-200 rounded-[2rem] font-black shadow-xl text-3xl active:scale-90 transition-all hover:bg-slate-50">+</button>
                                </div>
                                <p class="text-[9px] font-black text-slate-400 mt-6 uppercase italic tracking-[0.2em]">M√°ximo permitido: 30</p>
                            </div>
                            <div class="p-8 bg-violet-50 rounded-[3rem] border-2 border-violet-100 flex flex-col justify-center text-center relative overflow-hidden">
                                <span class="text-[11px] font-black text-violet-400 uppercase mb-2 italic tracking-widest">Tarifa Base por Hora</span>
                                <div class="flex items-center justify-center">
                                    <span class="text-4xl font-black text-violet-300 mr-2 italic">$</span>
                                    <input type="number" id="costPerHour" class="bg-transparent font-black text-6xl text-violet-700 outline-none italic text-center leading-none tracking-tighter w-full">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-600 ml-4 block mb-6 italic tracking-widest">Disponibilidad de Cupos por Horario</label>
                            <div id="court-hours-list" class="grid grid-cols-3 sm:grid-cols-5 gap-4"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer flex flex-col sm:flex-row justify-between items-center gap-10 bg-slate-900 text-white p-12">
                    <div class="text-left leading-none">
                        <span class="text-[11px] font-black text-violet-400 uppercase tracking-widest block mb-2 italic font-black leading-none">Total a Cobrar</span>
                        <p id="booking-total" class="text-7xl font-black italic tracking-tighter leading-none text-white">$0</p>
                    </div>
                    <div class="flex gap-4 w-full sm:w-auto">
                        <button type="button" onclick="window.closeModals()" class="flex-1 px-10 py-7 font-black text-slate-400 hover:text-white transition-colors uppercase text-[10px] tracking-widest">Cancelar</button>
                        <button type="submit" class="flex-2 bg-violet-600 text-white px-20 py-7 rounded-[3rem] font-black uppercase shadow-2xl active:scale-95 transition-all text-sm border-b-8 border-violet-800 italic tracking-widest">Confirmar Salto</button>
                    </div>
                </div>
                <input type="checkbox" id="rentGrill" class="hidden"><input type="number" id="grillCost" class="hidden">
            </form>
        </div>
    </div>

    <!-- MODAL VENTAS REDISE√ëADO (PRIORIDAD AL PEDIDO) -->
    <div id="sale-modal" class="modal">
        <div class="modal-content max-w-6xl">
            <div class="modal-header flex justify-between items-center text-left bg-slate-900 text-white border-none p-10 leading-none">
                <div>
                    <h3 class="text-4xl font-black text-orange-500 uppercase italic tracking-tighter leading-none">Caja de Kiosco</h3>
                    <p class="text-[10px] text-slate-500 font-bold uppercase mt-2 tracking-[0.4em] italic font-black">Control de Mercader√≠a AeroJump</p>
                </div>
                <button onclick="window.closeModals()" class="p-4 text-slate-600 hover:text-white transition-all active:scale-90 leading-none"><svg class="w-12 h-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="4"><path d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>

            <!-- Cabecera de b√∫squeda y m√©todos compacta -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-0 border-b-4 border-slate-100 bg-white">
                <div class="lg:col-span-8 p-6 lg:p-8 bg-white flex items-center">
                    <div class="relative w-full">
                        <input type="text" id="sale-catalog-filter" class="w-full p-5 bg-slate-50 rounded-[2rem] font-black text-2xl border-2 border-slate-200 outline-none focus:border-violet-500 shadow-inner italic transition-all placeholder:text-slate-300" placeholder="üîç Buscar Producto...">
                    </div>
                </div>
                <div class="lg:col-span-4 p-6 lg:p-8 bg-slate-50 flex items-center justify-center gap-6 border-l-2">
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <input type="radio" name="salePaymentMethod" value="efectivo" class="w-6 h-6 accent-orange-600 shadow-xl" checked>
                        <span class="font-black text-[10px] uppercase tracking-widest text-slate-700 italic group-hover:text-orange-600 transition-colors">Efectivo üíµ</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <input type="radio" name="salePaymentMethod" value="mercadopago" class="w-6 h-6 accent-violet-600 shadow-xl">
                        <span class="font-black text-[10px] uppercase tracking-widest text-slate-700 italic group-hover:text-violet-600 transition-colors">M.Pago üì±</span>
                    </label>
                </div>
            </div>

            <!-- Grilla Principal -->
            <div class="modal-body custom-scrollbar bg-slate-50 p-6 lg:p-10">
                <div id="sale-catalog-grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
                    <!-- Tarjetas de Productos -->
                </div>
            </div>
            
            <div class="modal-footer bg-slate-950 text-white p-10 lg:p-14">
                <div class="flex flex-col lg:flex-row justify-between items-center w-full gap-12">
                    <div class="text-left leading-none">
                        <span class="text-[12px] font-black text-violet-400 uppercase tracking-widest block mb-2 italic leading-none font-black">Monto Total Pedido</span>
                        <div class="flex items-baseline">
                            <span class="text-4xl font-black text-violet-300 mr-2 italic">$</span>
                            <span id="sale-total-display" class="text-[8rem] font-black italic tracking-tighter text-white leading-none">0</span>
                        </div>
                    </div>
                    
                    <button id="confirm-sale-btn" class="w-full lg:w-96 bg-orange-500 text-white py-12 rounded-[3.5rem] font-black uppercase shadow-2xl disabled:opacity-5 transition-all active:scale-95 italic text-2xl border-b-[12px] border-orange-800 tracking-tighter leading-none" disabled>Finalizar Venta AeroJump</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL REPOSICI√ìN -->
    <div id="restock-modal" class="modal"><div class="modal-content max-w-sm">
        <div class="modal-header text-left bg-violet-700 text-white border-none p-8 leading-none">
            <h3 class="text-2xl font-black uppercase italic tracking-tighter">üì¶ Reponer Stock</h3>
        </div>
        <div class="modal-body custom-scrollbar p-10">
            <form id="restock-form" class="space-y-10 text-left">
                <input type="hidden" id="restock-prod-id">
                <div class="p-8 bg-slate-50 rounded-[2.5rem] border-2 border-slate-100 text-center shadow-inner">
                    <h4 id="restock-name" class="font-black text-slate-950 text-3xl uppercase italic leading-tight mb-3"></h4>
                    <p class="text-[10px] font-black text-slate-500 uppercase italic leading-none">Saldo Actual: <span id="restock-current-stock" class="text-violet-700 font-black"></span> un.</p>
                </div>
                <div class="space-y-8">
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-500 italic ml-4 mb-2 block tracking-widest font-black">Unidades Ingresadas</label>
                        <input type="number" id="restock-qty" class="w-full p-6 bg-slate-50 rounded-3xl font-black text-5xl text-center border-2 border-slate-100 focus:ring-8 focus:ring-violet-50 outline-none transition-all leading-none italic" required>
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-500 italic ml-4 mb-2 block tracking-widest font-black">Costo Lote Completo ($)</label>
                        <input type="number" id="restock-batch-cost" class="w-full p-6 bg-violet-50 rounded-3xl font-black text-5xl text-violet-800 text-center border-2 border-violet-100 outline-none focus:ring-8 focus:ring-violet-50 transition-all leading-none italic" required step="0.01">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer p-10">
            <div class="flex gap-4">
                <button type="button" onclick="window.closeModals()" class="flex-1 py-6 font-black text-slate-400 uppercase text-[10px] tracking-widest italic">Cerrar</button>
                <button type="submit" form="restock-form" class="flex-2 bg-violet-700 text-white px-10 py-7 rounded-[2.5rem] font-black shadow-2xl active:scale-95 transition-all border-b-8 border-violet-950 italic text-xs tracking-widest">Confirmar Ingreso</button>
            </div>
        </div>
    </div></div>

    <!-- MODAL EDITAR PRODUCTO -->
    <div id="edit-product-modal" class="modal"><div class="modal-content max-w-sm p-12 text-left border-4 border-slate-100">
        <h3 class="text-3xl font-black text-slate-900 mb-10 uppercase italic leading-none tracking-tighter">Editar Ficha</h3>
        <form id="edit-product-form" class="space-y-8">
            <input type="hidden" id="edit-prod-id">
            <div>
                <label class="text-[10px] font-black uppercase text-slate-600 ml-4 italic mb-2 block tracking-widest font-black">Nombre Comercial</label>
                <input type="text" id="edit-prod-name" class="w-full p-6 bg-slate-50 rounded-[2rem] font-black text-2xl italic outline-none border-2 border-slate-100 focus:ring-8 focus:ring-violet-50 transition-all" required>
            </div>
            <div class="grid grid-cols-2 gap-6 leading-none">
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-600 ml-4 italic mb-2 block font-black">Costo Unidad ($)</label>
                    <input type="number" id="edit-prod-cost" class="w-full p-5 bg-slate-50 rounded-[1.5rem] font-black text-xl border-2 border-slate-100 leading-none" required step="0.01">
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-600 ml-4 italic mb-2 block font-black">Precio Venta ($)</label>
                    <input type="number" id="edit-prod-price" class="w-full p-5 bg-violet-50 rounded-[1.5rem] font-black text-xl text-violet-700 border-2 border-violet-200 leading-none" required step="0.01">
                </div>
            </div>
            <div>
                <label class="text-[10px] font-black uppercase text-slate-600 ml-4 italic mb-2 block tracking-widest font-black">Stock en Estanter√≠a</label>
                <input type="number" id="edit-prod-stock" class="w-full p-6 bg-slate-50 rounded-[2rem] font-black text-4xl border-2 border-slate-100 text-center leading-none italic" required>
            </div>
            <button type="submit" class="w-full bg-slate-950 text-white py-8 rounded-[3rem] font-black shadow-2xl uppercase italic active:scale-95 border-b-8 border-black text-sm tracking-widest mt-6">Guardar Ficha</button>
        </form>
    </div></div>

    <!-- MODAL OPCIONES D√çA -->
    <div id="options-modal" class="modal"><div class="modal-content max-w-sm p-10 text-center border-4 border-violet-100">
        <h3 class="text-3xl font-black mb-10 text-slate-900 uppercase italic tracking-tighter leading-none">Turnos del D√≠a</h3>
        <div id="daily-bookings-list" class="space-y-4 mb-10 text-left custom-scrollbar max-h-[25rem] overflow-y-auto italic pr-2"></div>
        <button id="add-new-booking-btn" class="w-full bg-violet-700 text-white py-7 rounded-[2rem] font-black shadow-xl uppercase text-xs active:scale-95 border-b-8 border-violet-950 italic tracking-widest">+ AGREGAR TURNO</button>
        <button onclick="window.closeModals()" class="mt-6 text-slate-400 font-black uppercase text-[10px] tracking-widest hover:text-slate-800 transition-colors italic leading-none">Volver</button>
    </div></div>

    <!-- OVERLAY CARGA -->
    <div id="message-overlay" class="modal bg-white/98 backdrop-blur-xl">
        <div class="flex flex-col items-center justify-center min-h-screen text-center p-10 leading-none">
            <svg width="160" height="160" viewBox="0 0 100 100" class="mb-12 shadow-2xl rounded-full">
                <path d="M10 80 Q 50 80 90 80" stroke="#7c3aed" stroke-width="12" fill="none" stroke-linecap="round" class="trampoline-line"/>
                <g class="jumping-child"><circle cx="50" cy="30" r="15" fill="#f97316"/><line x1="50" y1="45" x2="50" y2="78" stroke="#0f172a" stroke-width="8" stroke-linecap="round"/></g>
            </svg>
            <p id="message-text" class="text-5xl font-black text-slate-950 uppercase italic tracking-tighter leading-none"></p>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- L√ìGICA CORE v2026                            -->
    <!-- ============================================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, updateDoc, deleteDoc, collection, query, where, onSnapshot, getDocs, Timestamp, orderBy, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBz0V2ieSXehafKWRNQprb951NVN5FvBD4",
            authDomain: "aerojump-841fb.firebaseapp.com",
            projectId: "aerojump-841fb",
            storageBucket: "aerojump-841fb.firebasestorage.app",
            messagingSenderId: "68080726646",
            appId: "1:68080726646:web:a830613a1278871d416557"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appIdGlobal = "aerojump-gualeguaychu";

        const getPublicCollection = (name) => collection(db, 'artifacts', appIdGlobal, 'public', 'data', name);
        const getPublicDoc = (name, id) => doc(db, 'artifacts', appIdGlobal, 'public', 'data', name, id);

        // ESTADO GLOBAL
        let user = null;
        let allMonthBookings = [];
        let allProducts = [];
        let cartItems = {}; 
        let appSettings = { court1Price: 5000 };
        const MAX_CAPACITY = 30;
        const OPERATING_HOURS = [9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23];
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        let currentMonthDate = new Date();

        // ELEMENTOS DOM GLOBALES
        const calendarGrid = document.getElementById('calendar-grid');
        const currentMonthYearEl = document.getElementById('current-month-year');
        const courtHoursList = document.getElementById('court-hours-list');

        // --- AUTH CONTROL ---
        onAuthStateChanged(auth, async (u) => {
            if (u) {
                user = u;
                document.getElementById('user-email-display').textContent = u.email;
                document.getElementById('login-view').classList.add('is-hidden');
                document.getElementById('register-view').classList.add('is-hidden');
                document.getElementById('app-container').classList.remove('is-hidden');
                setupAppListeners();
                await initApp();
            } else {
                document.getElementById('login-view').classList.remove('is-hidden');
                document.getElementById('app-container').classList.add('is-hidden');
            }
        });

        async function initApp() {
            await loadSettings();
            syncBookings();
            syncProducts();
        }

        // --- CONFIGURACI√ìN DE NAVEGACI√ìN (BOTONES ARREGLADOS) ---
        function setupAppListeners() {
            // Hamburguesa
            document.getElementById('menu-btn').onclick = () => {
                document.getElementById('main-menu').classList.toggle('is-open');
                document.getElementById('menu-overlay').classList.toggle('hidden');
            };
            document.getElementById('menu-overlay').onclick = () => {
                document.getElementById('main-menu').classList.remove('is-open');
                document.getElementById('menu-overlay').classList.add('hidden');
            };

            // Bot√≥n Venta Header
            document.getElementById('header-sale-btn').onclick = () => {
                cartItems = {};
                document.getElementById('sale-catalog-filter').value = '';
                renderSaleCatalog();
                document.getElementById('sale-modal').classList.add('is-open');
            };

            // Botones Men√∫ Lateral (Cierre corregido)
            document.querySelectorAll('.menu-item').forEach(btn => {
                btn.onclick = (e) => {
                    const targetView = e.currentTarget.dataset.view;
                    document.querySelectorAll('.view-container').forEach(v => v.classList.add('is-hidden'));
                    const target = document.getElementById(`${targetView}-view`);
                    if(target) target.classList.remove('is-hidden');
                    
                    if(targetView === 'caja') loadCajaData();
                    if(targetView === 'stats') loadStatsData();
                    if(targetView === 'configuracion') loadConfigDataIntoForm();
                    
                    document.getElementById('main-menu').classList.remove('is-open');
                    document.getElementById('menu-overlay').classList.add('hidden');
                };
            });
        }

        // --- L√ìGICA OCUPACI√ìN ---
        function getOccupancyForDay(dateStr) {
            const occupancy = {};
            OPERATING_HOURS.forEach(h => occupancy[h] = 0);
            allMonthBookings.filter(b => b.day === dateStr).forEach(b => {
                const count = parseInt(b.peopleCount) || 0;
                b.courtHours.forEach(h => { if (occupancy[h] !== undefined) occupancy[h] += count; });
            });
            return occupancy;
        }

        function renderTimeSlots(dateStr, editingId = null) {
            const occupancy = getOccupancyForDay(dateStr);
            const currentBooking = allMonthBookings.find(b => b.id === editingId);
            const selectedHours = currentBooking ? currentBooking.courtHours : [];
            
            if (currentBooking) {
                const myCount = parseInt(currentBooking.peopleCount) || 0;
                selectedHours.forEach(h => { if(occupancy[h] !== undefined) occupancy[h] -= myCount; });
            }
            
            if(!courtHoursList) return;
            courtHoursList.innerHTML = '';
            OPERATING_HOURS.forEach(h => {
                const available = MAX_CAPACITY - occupancy[h];
                const isFull = available <= 0;
                const btn = document.createElement('button');
                btn.type = "button";
                btn.className = `time-slot ${isFull ? 'disabled' : ''} ${selectedHours.includes(h) ? 'selected' : ''}`;
                btn.innerHTML = `<span class="font-black text-xl leading-none italic">${h}:00</span><span class="capacity-info ${available < 5 ? 'text-red-700' : 'text-slate-500'}">${available} libres</span>`;
                if (!isFull) { btn.onclick = () => { btn.classList.toggle('selected'); updateBookingPrice(); }; }
                courtHoursList.appendChild(btn);
            });
        }

        // --- CATALOGO VENTA (VISUAL PREMIUM) ---
        function renderSaleCatalog(filter = "") {
            const container = document.getElementById('sale-catalog-grid');
            if(!container) return;
            container.innerHTML = '';
            const filtered = allProducts.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()));
            
            filtered.forEach(p => {
                const qty = cartItems[p.id] || 0;
                const card = document.createElement('div');
                card.className = 'product-sale-card';
                card.innerHTML = `
                    <div class="text-left mb-6 leading-none">
                        <p class="font-black text-sm uppercase text-slate-950 leading-tight mb-2 italic">${p.name}</p>
                        <span class="text-[9px] font-black px-3 py-1.5 bg-violet-100 text-violet-800 rounded-xl uppercase tracking-widest leading-none shadow-inner">Stock: ${p.stock} un.</span>
                    </div>
                    <div class="flex justify-between items-center bg-slate-950 p-3 rounded-[1.5rem] shadow-2xl border-2 border-slate-900 transition-all hover:bg-black">
                        <strong class="text-3xl font-black text-white italic tracking-tighter leading-none ml-2">$${p.salePrice}</strong>
                        <div class="flex items-center gap-3">
                            <button onclick="window.updateCatalogQty('${p.id}', -1)" class="w-12 h-12 bg-white/10 rounded-2xl font-black text-white hover:bg-red-600 transition-all text-2xl active:scale-90">-</button>
                            <span class="w-8 text-center font-black text-3xl italic ${qty > 0 ? 'text-orange-400' : 'text-white/20'}">${qty}</span>
                            <button onclick="window.updateCatalogQty('${p.id}', 1)" class="w-12 h-12 bg-white/10 rounded-2xl font-black text-white hover:bg-green-600 transition-all text-2xl active:scale-90" ${qty >= p.stock ? 'disabled' : ''}>+</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            updateSaleTotal();
        }

        window.updateCatalogQty = (id, delta) => {
            const p = allProducts.find(x => x.id === id);
            if(!p) return;
            let current = cartItems[id] || 0;
            current += delta;
            if (current <= 0) delete cartItems[id];
            else if (current > p.stock) current = p.stock;
            else cartItems[id] = current;
            renderSaleCatalog(document.getElementById('sale-catalog-filter').value);
        };

        function updateSaleTotal() {
            let total = 0;
            Object.keys(cartItems).forEach(id => {
                const p = allProducts.find(x => x.id === id);
                if(p) total += (p.salePrice * cartItems[id]);
            });
            document.getElementById('sale-total-display').textContent = `${total.toLocaleString()}`;
            document.getElementById('confirm-sale-btn').disabled = total <= 0;
        }

        document.getElementById('confirm-sale-btn').onclick = async () => {
            const btn = document.getElementById('confirm-sale-btn');
            const methodEl = document.querySelector('input[name="salePaymentMethod"]:checked');
            if(!methodEl) return alert("Selecciona m√©todo de pago");
            const method = methodEl.value;
            btn.disabled = true;
            try {
                const batch = writeBatch(db);
                const hoy = new Date().toISOString().split('T')[0];
                for (const id of Object.keys(cartItems)) {
                    const p = allProducts.find(x => x.id === id);
                    const qty = cartItems[id];
                    batch.set(doc(collection(db, "sales")), {
                        name: p.name, qty, total: p.salePrice * qty, paymentMethod: method,
                        day: hoy, monthYear: hoy.substring(0, 7), timestamp: Timestamp.now(), adminEmail: user.email
                    });
                    batch.update(getPublicDoc("products", id), { stock: p.stock - qty });
                }
                await batch.commit();
                showMessage("Cobro finalizado con √©xito AeroJump!");
                setTimeout(() => { hideMessage(); window.closeModals(); }, 1500);
            } catch (err) { alert(err.message); btn.disabled = false; }
        };

        // --- CALENDARIO & SYNC ---
        function syncBookings() {
            const monthYear = `${currentMonthDate.getFullYear()}-${String(currentMonthDate.getMonth() + 1).padStart(2, '0')}`;
            onSnapshot(query(getPublicCollection("bookings"), where("monthYear", "==", monthYear)), (snap) => {
                allMonthBookings = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderCalendar();
            });
        }

        function renderCalendar() {
            if(!calendarGrid) return;
            calendarGrid.innerHTML = '';
            currentMonthYearEl.textContent = `${monthNames[currentMonthDate.getMonth()]} ${currentMonthDate.getFullYear()}`;
            const firstDay = new Date(currentMonthDate.getFullYear(), currentMonthDate.getMonth(), 1).getDay();
            const lastDate = new Date(currentMonthDate.getFullYear(), currentMonthDate.getMonth() + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) { calendarGrid.appendChild(document.createElement('div')); }
            for (let i = 1; i <= lastDate; i++) {
                const ds = `${currentMonthDate.getFullYear()}-${String(currentMonthDate.getMonth() + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const bks = allMonthBookings.filter(b => b.day === ds);
                const cell = document.createElement('div');
                cell.className = 'day-cell p-4 flex flex-col justify-between text-left';
                cell.innerHTML = `<span class="font-black italic text-slate-950 text-2xl tracking-tighter leading-none">${i}</span>`;
                if (bks.length > 0) {
                    const badge = document.createElement('div');
                    badge.className = `booking-count ${bks.some(b => b.type === 'event') ? 'event' : ''} mt-1 leading-none`;
                    badge.textContent = bks.length;
                    cell.appendChild(badge);
                }
                cell.onclick = () => { if(bks.length > 0) showOptionsModal(ds, bks); else window.showBookingModal(ds); };
                calendarGrid.appendChild(cell);
            }
        }

        function showOptionsModal(ds, bks) {
            const list = document.getElementById('daily-bookings-list');
            if(!list) return;
            list.innerHTML = '';
            bks.forEach(b => {
                const it = document.createElement('div');
                it.className = 'p-6 bg-slate-50 rounded-3xl mb-4 flex justify-between items-center border-2 border-slate-100 transition-all hover:bg-white shadow-sm';
                it.innerHTML = `<div><p class="font-black text-sm uppercase leading-none mb-2 text-slate-900">${b.teamName}</p><p class="text-[10px] font-black text-slate-400 italic tracking-widest">${b.courtHours.join(', ')}hs | ${b.peopleCount} pers.</p></div>`;
                const del = document.createElement('button');
                del.className = 'bg-orange-100 text-orange-700 px-5 py-3 rounded-2xl font-black text-[10px] uppercase hover:bg-orange-600 hover:text-white transition-all italic leading-none';
                del.textContent = 'Anular';
                del.onclick = async () => { if(confirm("¬øConfirmas la baja definitiva?")) { await deleteDoc(getPublicDoc("bookings", b.id)); window.closeModals(); } };
                it.appendChild(del);
                list.appendChild(it);
            });
            document.getElementById('add-new-booking-btn').onclick = () => { window.closeModals(); window.showBookingModal(ds); };
            document.getElementById('options-modal').classList.add('is-open');
        }

        // --- PRODUCTOS & INVENTARIO ---
        function syncProducts() {
            onSnapshot(getPublicCollection("products"), (snap) => {
                allProducts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderInventory();
                if(document.getElementById('sale-modal').classList.contains('is-open')) renderSaleCatalog(document.getElementById('sale-catalog-filter').value);
            });
        }

        function renderInventory() {
            const list = document.getElementById('product-list');
            if(!list) return;
            list.innerHTML = '';
            allProducts.forEach(p => {
                const card = document.createElement('div');
                card.className = 'inventory-card flex flex-col gap-6 text-left relative overflow-hidden group';
                card.innerHTML = `
                    <div class="flex justify-between items-start leading-none relative z-10">
                        <div class="text-left">
                            <h4 class="font-black italic uppercase text-slate-950 text-2xl mb-2 tracking-tighter leading-tight">${p.name}</h4>
                            <span class="text-[10px] font-black uppercase text-violet-700 bg-violet-100 px-3 py-1.5 rounded-xl border-2 border-violet-200 leading-none shadow-inner">En Stock: ${p.stock} un.</span>
                        </div>
                        <strong class="text-5xl font-black text-slate-950 italic tracking-tighter leading-none">$${p.salePrice}</strong>
                    </div>
                    <div class="grid grid-cols-2 gap-3 relative z-10">
                        <button onclick="window.openEditProduct('${p.id}')" class="bg-slate-100 text-slate-700 py-4 rounded-2xl font-black text-[10px] uppercase hover:bg-slate-900 hover:text-white transition-all italic tracking-widest border-2 border-slate-200">Ficha</button>
                        <button onclick="window.openRestock('${p.id}')" class="bg-violet-100 text-violet-700 py-4 rounded-2xl font-black text-[10px] uppercase hover:bg-violet-700 hover:text-white transition-all italic tracking-widest border-2 border-violet-200">Reponer</button>
                        <button onclick="window.deleteProduct('${p.id}')" class="col-span-2 bg-orange-100 text-orange-700 py-4 rounded-2xl font-black text-[10px] uppercase hover:bg-orange-600 hover:text-white transition-all italic tracking-widest border-2 border-orange-200 shadow-xl">Eliminar Ficha</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        // --- SETTINGS ---
        async function loadSettings() {
            try {
                const d = await getDoc(getPublicDoc("app_settings", "prices"));
                if (d.exists()) { appSettings = d.data(); if(document.getElementById('config-court1-price')) document.getElementById('config-court1-price').value = appSettings.court1Price; }
            } catch(e) {}
        }

        function loadConfigDataIntoForm() {
            document.getElementById('config-court1-price').value = appSettings.court1Price;
        }

        // --- GLOBAL ACTIONS ---
        window.closeModals = () => { document.querySelectorAll('.modal').forEach(m => m.classList.remove('is-open')); };
        window.adjustJumpers = (val) => {
            const input = document.getElementById('peopleCount');
            let n = parseInt(input.value) + val;
            if (n < 1) n = 1; if (n > 30) n = 30;
            input.value = n;
            renderTimeSlots(document.getElementById('booking-date').value, document.getElementById('booking-id').value);
            updateBookingPrice();
        };

        window.showBookingModal = async (dateStr, booking = null) => {
            const form = document.getElementById('booking-form');
            form.reset();
            document.getElementById('booking-date').value = dateStr;
            document.getElementById('booking-id').value = booking ? booking.id : '';
            document.getElementById('teamName').value = booking ? booking.teamName : '';
            document.getElementById('peopleCount').value = booking ? booking.peopleCount : 1;
            document.getElementById('costPerHour').value = appSettings.court1Price;
            renderTimeSlots(dateStr, booking?.id);
            updateBookingPrice();
            document.getElementById('booking-modal').classList.add('is-open');
        };

        window.openEditProduct = (id) => {
            const p = allProducts.find(x => x.id === id);
            document.getElementById('edit-prod-id').value = id;
            document.getElementById('edit-prod-name').value = p.name;
            document.getElementById('edit-prod-cost').value = p.unitCost || 0;
            document.getElementById('edit-prod-price').value = p.salePrice;
            document.getElementById('edit-prod-stock').value = p.stock;
            document.getElementById('edit-product-modal').classList.add('is-open');
        };

        window.openRestock = (id) => {
            const p = allProducts.find(x => x.id === id);
            document.getElementById('restock-prod-id').value = id;
            document.getElementById('restock-name').textContent = p.name;
            document.getElementById('restock-current-stock').textContent = p.stock;
            document.getElementById('restock-modal').classList.add('is-open');
        };

        window.prevMonth = () => { currentMonthDate.setMonth(currentMonthDate.getMonth() - 1); syncBookings(); };
        window.nextMonth = () => { currentMonthDate.setMonth(currentMonthDate.getMonth() + 1); syncBookings(); };
        window.deleteProduct = async (id) => { if(confirm("¬øEliminar ficha AeroJump?")) await deleteDoc(getPublicDoc("products", id)); };

        // --- SUBMITS ---
        document.getElementById('booking-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            const selected = Array.from(document.getElementById('court-hours-list').querySelectorAll('.time-slot.selected')).map(el => parseInt(el.querySelector('span').textContent));
            if (selected.length === 0) { btn.disabled = false; return alert("Selecciona Horarios"); }
            
            const data = {
                teamName: document.getElementById('teamName').value.trim(),
                day: document.getElementById('booking-date').value,
                monthYear: document.getElementById('booking-date').value.substring(0, 7),
                peopleCount: parseInt(document.getElementById('peopleCount').value),
                costPerHour: parseFloat(document.getElementById('costPerHour').value),
                courtHours: selected,
                totalPrice: parseFloat(document.getElementById('booking-total').textContent.replace('$','').replace('.','').replace(',','')),
                timestamp: Timestamp.now(), adminEmail: user.email, type: 'court'
            };
            try {
                const id = document.getElementById('booking-id').value;
                if (id) await updateDoc(getPublicDoc("bookings", id), data);
                else await addDoc(getPublicCollection("bookings"), data);
                window.closeModals();
            } catch (err) { alert(err.message); } finally { btn.disabled = false; }
        };

        document.getElementById('product-form').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('prod-name').value.trim(),
                stock: parseInt(document.getElementById('prod-stock').value),
                salePrice: parseFloat(document.getElementById('prod-suggested-price').textContent.replace('$','')),
                unitCost: parseFloat(document.getElementById('prod-unit-cost').value),
                createdAt: Timestamp.now()
            };
            try {
                await addDoc(getPublicCollection("products"), data);
                e.target.reset(); document.getElementById('product-form-container').classList.add('is-hidden');
            } catch(e) { alert(e.message); }
        };

        document.getElementById('edit-product-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-prod-id').value;
            const data = {
                name: document.getElementById('edit-prod-name').value,
                unitCost: parseFloat(document.getElementById('edit-prod-cost').value),
                salePrice: parseFloat(document.getElementById('edit-prod-price').value),
                stock: parseInt(document.getElementById('edit-prod-stock').value)
            };
            await updateDoc(getPublicDoc("products", id), data);
            window.closeModals();
        };

        document.getElementById('restock-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('restock-prod-id').value;
            const addQ = parseInt(document.getElementById('restock-qty').value);
            const bCost = parseFloat(document.getElementById('restock-batch-cost').value);
            const p = allProducts.find(x => x.id === id);
            const nUnit = bCost / addQ;
            await updateDoc(getPublicDoc("products", id), {
                stock: p.stock + addQ,
                unitCost: nUnit,
                salePrice: Math.ceil(nUnit * 1.4)
            });
            window.closeModals();
        };

        window.calculateProductPrices = () => {
            const cost = parseFloat(document.getElementById('prod-batch-cost').value) || 0;
            const qty = parseInt(document.getElementById('prod-batch-qty').value) || 1;
            const unit = cost / qty;
            const margin = parseFloat(document.getElementById('prod-profit-pct').value || 40);
            const sugg = Math.ceil(unit * (1 + (margin / 100)));
            document.getElementById('prod-suggested-price').textContent = `$${sugg}`;
            document.getElementById('prod-unit-cost').value = unit;
        };

        document.getElementById('config-form').onsubmit = async (e) => {
            e.preventDefault();
            const val = parseFloat(document.getElementById('config-court1-price').value);
            await setDoc(getPublicDoc("app_settings", "prices"), { court1Price: val }, { merge: true });
            appSettings.court1Price = val;
            showMessage("Tarifas actualizadas!"); setTimeout(hideMessage, 1500);
        };

        function loadCajaData() {
            onSnapshot(query(getPublicCollection("sales"), orderBy("timestamp", "desc")), (snap) => {
                const list = document.getElementById('caja-daily-list');
                if(!list) return;
                list.innerHTML = ''; let total = 0;
                snap.forEach(d => {
                    const s = d.data(); total += s.total || 0;
                    list.innerHTML += `<div class="bg-white p-6 rounded-3xl shadow-sm border-2 border-slate-100 flex justify-between items-center hover:bg-slate-50 transition-all">
                        <div class="text-left leading-none"><p class="font-black text-sm uppercase text-slate-900 mb-2">${s.name} (x${s.qty})</p><p class="text-[9px] font-black text-slate-500 uppercase tracking-widest">${s.day} | ${s.paymentMethod || 'Efectivo'}</p></div>
                        <strong class="text-orange-600 font-black italic text-2xl tracking-tighter">$${(s.total || 0).toLocaleString()}</strong>
                    </div>`;
                });
                document.getElementById('caja-total-combined').textContent = `$${total.toLocaleString()}`;
            });
        }

        function loadStatsData() {
            const statsList = document.getElementById('stats-list');
            if(!statsList) return;
            const rank = {};
            allMonthBookings.forEach(b => { if(!rank[b.teamName]) rank[b.teamName] = 0; rank[b.teamName]++; });
            statsList.innerHTML = Object.entries(rank).sort((a,b)=>b[1]-a[1]).map(([name, count]) => `
                <div class="bg-white p-5 rounded-2xl flex justify-between items-center shadow-sm border-2 border-slate-50 italic uppercase font-black">
                    <div><span class="text-slate-900">${name}</span><p class="text-[9px] text-slate-400 mt-1">${count} reservas este mes</p></div>
                    <span class="text-violet-700 text-xl">#${count}</span>
                </div>
            `).join('');
        }

        function showMessage(msg, isE = false) { const t = document.getElementById('message-text'); if(t) t.textContent = msg; document.getElementById('message-overlay').classList.add('is-open'); }
        function hideMessage() { document.getElementById('message-overlay').classList.remove('is-open'); }
        document.getElementById('sale-catalog-filter').oninput = (e) => renderSaleCatalog(e.target.value);
        document.getElementById('login-form').onsubmit = (e) => { e.preventDefault(); signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value); };
        document.getElementById('logout-btn').onclick = () => signOut(auth);
        document.getElementById('add-product-btn').onclick = () => document.getElementById('product-form-container').classList.toggle('is-hidden');
        document.getElementById('cancel-product-btn').onclick = () => document.getElementById('product-form-container').classList.add('is-hidden');

    </script>
</body>
</html>
